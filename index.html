 <!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>加工部門數位日報表系統 v7.0</title>
    <!-- 引入SheetJS for Excel export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            overflow-x: hidden;
        }

        .container {
            max-width: 100%;
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 32px;
            margin-bottom: 10px;
        }

        .header .date-info {
            font-size: 18px;
            opacity: 0.9;
        }

        .main-content {
            padding: 30px;
            overflow-x: hidden;
        }

        .employee-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .employee-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
        }

        .input-group label {
            font-weight: bold;
            color: #495057;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .input-group input, .input-group select {
            padding: 10px;
            border: 2px solid #dee2e6;
            border-radius: 5px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .input-group input:focus, .input-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .fixed-department {
            padding: 10px;
            background: #e9ecef;
            border: 2px solid #dee2e6;
            border-radius: 5px;
            font-size: 16px;
            font-weight: bold;
        }

        .time-entries {
            margin-top: 30px;
        }

        .time-entries h3 {
            color: #495057;
            margin-bottom: 15px;
            font-size: 20px;
        }

        .entries-container {
            padding: 10px;
            background: #f8f9fa;
            border-radius: 10px;
            overflow-x: auto;
            overflow-y: visible;
        }

        .entry-card {
            background: white;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            transition: all 0.3s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            overflow-x: auto;
            position: relative;
        }

        .entry-card:hover {
            border-color: #667eea;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.2);
        }

        .entry-card.error {
            border-color: #dc3545;
            background: #fff5f5;
        }

        .entry-card.highlight {
            border-color: #ffc107;
            background: #fffbf0;
            animation: pulse 1s 2;
        }

        .entry-card-header {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            margin-bottom: 15px;
            gap: 10px;
        }

        .entry-fields {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            width: 100%;
        }

        .field-group {
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 0;
        }

        .field-label {
            min-width: 80px;
            font-weight: bold;
            color: #495057;
            font-size: 14px;
            text-align: right;
            flex-shrink: 0;
        }

        .field-input {
            flex: 1;
            padding: 8px;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            font-size: 14px;
            min-width: 0;
        }

        .field-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
        }

        .field-input.invalid {
            border-color: #dc3545;
            background: #fff5f5;
        }

        .field-input[readonly] {
            background: #e9ecef;
            cursor: not-allowed;
        }

        .card-actions {
            display: flex;
            justify-content: flex-end;
            margin-top: 15px;
            gap: 10px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
            white-space: nowrap;
        }

        .btn-add {
            background: #28a745;
            color: white;
            margin-top: 10px;
        }

        .btn-add:hover {
            background: #218838;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
        }

        .btn-delete {
            background: #dc3545;
            color: white;
            padding: 8px 15px;
        }

        .btn-delete:hover {
            background: #c82333;
        }

        .btn-copy {
            background: #007bff;
            color: white;
            padding: 8px 15px;
        }

        .btn-copy:hover {
            background: #0056b3;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 30px;
            font-size: 16px;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .validation-section {
            margin-top: 30px;
            padding: 20px;
            background: #e8f4f8;
            border-radius: 10px;
            border-left: 5px solid #17a2b8;
        }

        .validation-section h3 {
            color: #17a2b8;
            margin-bottom: 15px;
        }

        .validation-status {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }

        .status-item {
            padding: 15px;
            background: white;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .status-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .status-item.error {
            border: 2px solid #dc3545;
        }

        .status-item.error:hover {
            background: #fff5f5;
        }

        .status-icon {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .status-icon.success {
            background: #28a745;
            color: white;
        }

        .status-icon.error {
            background: #dc3545;
            color: white;
        }

        .status-icon.warning {
            background: #ffc107;
            color: white;
        }

        .actions {
            margin-top: 30px;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
        }

        .quick-fill {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .btn-quick {
            background: #6c757d;
            color: white;
        }

        .btn-quick:hover {
            background: #5a6268;
        }

        .btn-sweep {
            background: #17a2b8;
            color: white;
        }

        .btn-sweep:hover {
            background: #138496;
        }

        .message {
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            display: none;
            animation: slideDown 0.3s ease-out;
        }

        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            display: block;
        }

        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            display: block;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            overflow: auto;
        }

        .modal-content {
            background-color: #fefefe;
            margin: 2% auto;
            padding: 0;
            border: 1px solid #888;
            width: 95%;
            max-width: 1600px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            margin: 0;
        }

        .modal-body {
            padding: 20px;
            overflow: auto;
            flex: 1;
            touch-action: pinch-zoom;
            -webkit-overflow-scrolling: touch;
        }

        .modal-close {
            color: white;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            background: none;
            border: none;
            padding: 0;
            line-height: 1;
        }

        .modal-close:hover {
            opacity: 0.7;
        }

        .preview-content {
            transform-origin: center;
            transition: transform 0.2s;
            touch-action: manipulation;
            min-width: 100%;
        }

        .preview-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .preview-table th, .preview-table td {
            border: 1px solid #dee2e6;
            padding: 10px;
            text-align: left;
            white-space: nowrap;
        }

        .preview-table th {
            background: #f8f9fa;
            font-weight: bold;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .preview-table tbody tr:hover {
            background: #f1f3f5;
        }

        .preview-table td input {
            width: 100%;
            min-width: 80px;
            border: 1px solid transparent;
            background: transparent;
            padding: 5px;
        }

        .preview-table td input:focus {
            border: 1px solid #667eea;
            background: white;
            outline: none;
        }

        .summary-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .summary-label {
            font-weight: bold;
            color: #495057;
        }

        .summary-value {
            color: #667eea;
            font-weight: bold;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
            100% {
                transform: scale(1);
            }
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .shake {
            animation: shake 0.5s;
        }

        .required-mark {
            color: #dc3545;
            font-weight: bold;
        }

        .memory-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            background: #28a745;
            border-radius: 50%;
            margin-left: 5px;
            animation: pulse 2s infinite;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 24px;
            }
            
            .entry-fields {
                grid-template-columns: 1fr;
            }
            
            .field-label {
                min-width: 70px;
                font-size: 12px;
            }
            
            .actions {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }
            
            .modal-content {
                width: 98%;
                margin: 1% auto;
            }

            .preview-table {
                font-size: 12px;
            }

            .preview-table th, .preview-table td {
                padding: 5px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🏭 加工部門數位日報表系統 v7.0</h1>
            <div class="date-info">
                <span id="currentDate"></span> | 
                <span id="currentTime"></span>
            </div>
        </div>

        <div class="main-content">
            <div class="employee-section">
                <div class="employee-info">
                    <div class="input-group">
                        <label for="employeeId">
                            員工編號 <span class="required-mark">*</span>
                            <span id="memoryIndicatorId" class="memory-indicator" style="display:none" title="已記憶"></span>
                        </label>
                        <input type="text" id="employeeId" placeholder="例：E001" />
                    </div>
                    <div class="input-group">
                        <label for="employeeName">
                            員工姓名 <span class="required-mark">*</span>
                            <span id="memoryIndicatorName" class="memory-indicator" style="display:none" title="已記憶"></span>
                        </label>
                        <input type="text" id="employeeName" placeholder="請輸入姓名" />
                    </div>
                    <div class="input-group">
                        <label for="department">部門</label>
                        <div class="fixed-department">加工部</div>
                    </div>
                    <div class="input-group">
                        <label for="reportDate">報表日期 <span class="required-mark">*</span></label>
                        <input type="date" id="reportDate" />
                    </div>
                </div>
            </div>

            <div class="time-entries">
                <h3>📝 工作時段記錄</h3>
                
                <div class="quick-fill">
                    <button class="btn btn-sweep" onclick="fillSweepingTime()">
                        🧹 掃地時間 (8:00-8:15)
                    </button>
                    <button class="btn btn-quick" onclick="clearAll()">
                        🗑️ 清空所有
                    </button>
                </div>

                <div class="entries-container" id="entriesContainer">
                    <!-- 動態生成的時段卡片將插入這裡 -->
                </div>
                
                <button class="btn btn-add" onclick="addNewRow()">
                    ➕ 新增時段
                </button>
            </div>

            <div class="validation-section">
                <h3>✅ 時間驗證狀態</h3>
                <div class="validation-status">
                    <div class="status-item" id="morningStatusItem" onclick="jumpToError('morning')">
                        <div class="status-icon" id="morningStatus">?</div>
                        <div>
                            <strong>上午時段</strong><br>
                            <small id="morningText">待驗證 (8:00-12:00)</small>
                        </div>
                    </div>
                    <div class="status-item" id="afternoonStatusItem" onclick="jumpToError('afternoon')">
                        <div class="status-icon" id="afternoonStatus">?</div>
                        <div>
                            <strong>下午時段</strong><br>
                            <small id="afternoonText">待驗證 (13:00-17:00)</small>
                        </div>
                    </div>
                    <div class="status-item" id="workHoursStatusItem">
                        <div class="status-icon" id="workHoursStatus">?</div>
                        <div>
                            <strong>缺少工作時段</strong><br>
                            <small id="workHoursText">待計算（需滿8小時）</small>
                        </div>
                    </div>
                    <div class="status-item" id="dataStatusItem" onclick="jumpToError('data')">
                        <div class="status-icon" id="dataStatus">?</div>
                        <div>
                            <strong>資料完整性</strong><br>
                            <small id="dataText">待驗證</small>
                        </div>
                    </div>
                </div>
            </div>

            <div id="messageBox" class="message"></div>

            <div class="actions">
                <button class="btn btn-primary" onclick="validateAndSave()">
                    💾 驗證並儲存
                </button>
                <button class="btn btn-primary" onclick="exportToExcel()">
                    📊 匯出Excel
                </button>
                <button class="btn btn-primary" onclick="previewReport()">
                    👁️ 預覽報表
                </button>
            </div>
        </div>
    </div>

    <!-- Modal for Preview -->
    <div id="previewModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>📋 報表預覽</h2>
                <button class="modal-close" onclick="closePreviewModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="modalBody" class="preview-content">
                    <!-- 預覽內容將插入這裡 -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // 全域變數
        let entryCount = 0;
        let errorCards = {
            morning: [],
            afternoon: [],
            data: []
        };
        let currentScale = 1;
        let lastMachineSelection = '1.PC-55V';

        // 製程代號對應表
        const processMapping = {
            'A': '領料/準備/架模',
            'A1': '換線/程式編寫',
            'AA1': '架模/程式',
            'B': '加工',
            '51': '清洗（清潔）',
            'G': '去毛邊',
            'U1': '會議/訓練',
            'U2': '設備停機',
            'U3': '停工待料',
            'U4': '品質確認',
            'U5': '工務',
            'U6': '精實專案',
            'U7': '開治具',
            'U8': '待機',
            'U10': '請假'
        };

        // 初始化日期和時間
        function initDateTime() {
            const now = new Date();
            document.getElementById('reportDate').value = now.toISOString().split('T')[0];
            updateDateTime();
            setInterval(updateDateTime, 1000);
        }

        function updateDateTime() {
            const now = new Date();
            const dateStr = now.toLocaleDateString('zh-TW', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                weekday: 'long'
            });
            const timeStr = now.toLocaleTimeString('zh-TW');
            
            document.getElementById('currentDate').textContent = dateStr;
            document.getElementById('currentTime').textContent = timeStr;
        }

        // 載入記憶的員工資料
        function loadEmployeeData() {
            const savedId = localStorage.getItem('employeeId');
            const savedName = localStorage.getItem('employeeName');
            
            if (savedId) {
                document.getElementById('employeeId').value = savedId;
                document.getElementById('memoryIndicatorId').style.display = 'inline-block';
            }
            
            if (savedName) {
                document.getElementById('employeeName').value = savedName;
                document.getElementById('memoryIndicatorName').style.display = 'inline-block';
            }
        }

        // 儲存員工資料到本地儲存
        function saveEmployeeData() {
            const employeeId = document.getElementById('employeeId').value;
            const employeeName = document.getElementById('employeeName').value;
            
            if (employeeId) {
                localStorage.setItem('employeeId', employeeId);
                document.getElementById('memoryIndicatorId').style.display = 'inline-block';
            }
            
            if (employeeName) {
                localStorage.setItem('employeeName', employeeName);
                document.getElementById('memoryIndicatorName').style.display = 'inline-block';
            }
        }

        // 監聽員工資料變更
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('employeeId').addEventListener('change', saveEmployeeData);
            document.getElementById('employeeName').addEventListener('change', saveEmployeeData);
            
            // 初始化觸控縮放
            initTouchZoom();
        });

        // 取得最後一筆記錄的結束時間
        function getLastEndTime() {
            const cards = document.querySelectorAll('.entry-card');
            if (cards.length === 0) return '';
            
            const lastCard = cards[cards.length - 1];
            const endTimeInput = lastCard.querySelector('.end-time');
            return endTimeInput ? endTimeInput.value : '';
        }

        // 更新最後選擇的機台
        function updateLastMachine(select) {
            lastMachineSelection = select.value;
        }

        // 創建時段卡片
        function createTimeCard(data = {}) {
            entryCount++;
            const cardNum = entryCount;
            
            // 預設值 - 使用最後選擇的機台
            const defaults = {
                startTime: data.startTime || getLastEndTime() || '',
                endTime: data.endTime || '',
                machine: data.machine || lastMachineSelection,
                process: data.process || 'B',
                orderNo: data.orderNo || '',
                partNo: data.partNo || '',
                orderQty: data.orderQty || '',
                good: data.good || '',
                bad: data.bad || '0',
                remark: data.remark || ''
            };
            
            const card = document.createElement('div');
            card.className = 'entry-card';
            card.setAttribute('data-card-id', `card-${cardNum}`);
            card.innerHTML = `
                <div class="entry-card-header">
                    <button class="btn btn-delete" onclick="deleteCard(this)">刪除</button>
                </div>
                <div class="entry-fields">
                    <div class="field-group">
                        <label class="field-label">開始:</label>
                        <input type="time" class="field-input start-time" value="${defaults.startTime}" onchange="validateTime()" />
                    </div>
                    <div class="field-group">
                        <label class="field-label">結束:</label>
                        <input type="time" class="field-input end-time" value="${defaults.endTime}" onchange="validateTime()" />
                    </div>
                    <div class="field-group">
                        <label class="field-label">使用機台:</label>
                        <select class="field-input machine-select" onchange="updateLastMachine(this)">
                            <option value="1.PC-55V" ${defaults.machine === '1.PC-55V' ? 'selected' : ''}>1.PC-55V</option>
                            <option value="2.NC-2000" ${defaults.machine === '2.NC-2000' ? 'selected' : ''}>2.NC-2000</option>
                            <option value="3.BMC-80" ${defaults.machine === '3.BMC-80' ? 'selected' : ''}>3.BMC-80</option>
                            <option value="4.車床" ${defaults.machine === '4.車床' ? 'selected' : ''}>4.車床</option>
                            <option value="5.三米五面" ${defaults.machine === '5.三米五面' ? 'selected' : ''}>5.三米五面</option>
                            <option value="6.五米五面" ${defaults.machine === '6.五米五面' ? 'selected' : ''}>6.五米五面</option>
                            <option value="7.BF-130" ${defaults.machine === '7.BF-130' ? 'selected' : ''}>7.BF-130</option>
                            <option value="8.A+2100" ${defaults.machine === '8.A+2100' ? 'selected' : ''}>8.A+2100</option>
                            <option value="9.程式編寫" ${defaults.machine === '9.程式編寫' ? 'selected' : ''}>9.程式編寫</option>
                            <option value="X" ${defaults.machine === 'X' ? 'selected' : ''}>X</option>
                        </select>
                    </div>
                    <div class="field-group">
                        <label class="field-label">製程代號:</label>
                        <select class="field-input process-select" onchange="handleProcessChange(this)">
                            <option value="A" ${defaults.process === 'A' ? 'selected' : ''}>A(領料/準備/架模)</option>
                            <option value="A1" ${defaults.process === 'A1' ? 'selected' : ''}>A1(換線/程式編寫)</option>
                            <option value="AA1" ${defaults.process === 'AA1' ? 'selected' : ''}>AA1(架模/程式)</option>
                            <option value="B" ${defaults.process === 'B' ? 'selected' : ''}>B(加工)</option>
                            <option value="51" ${defaults.process === '51' ? 'selected' : ''}>51(清洗（清潔）)</option>
                            <option value="G" ${defaults.process === 'G' ? 'selected' : ''}>G(去毛邊)</option>
                            <option value="U1" ${defaults.process === 'U1' ? 'selected' : ''}>U1(會議/訓練)</option>
                            <option value="U2" ${defaults.process === 'U2' ? 'selected' : ''}>U2(設備停機)</option>
                            <option value="U3" ${defaults.process === 'U3' ? 'selected' : ''}>U3(停工待料)</option>
                            <option value="U4" ${defaults.process === 'U4' ? 'selected' : ''}>U4(品質確認)</option>
                            <option value="U5" ${defaults.process === 'U5' ? 'selected' : ''}>U5(工務)</option>
                            <option value="U6" ${defaults.process === 'U6' ? 'selected' : ''}>U6(精實專案)</option>
                            <option value="U7" ${defaults.process === 'U7' ? 'selected' : ''}>U7(開治具)</option>
                            <option value="U8" ${defaults.process === 'U8' ? 'selected' : ''}>U8(待機)</option>
                            <option value="U10" ${defaults.process === 'U10' ? 'selected' : ''}>U10(請假)</option>
                        </select>
                    </div>
                    <div class="field-group">
                        <label class="field-label">製令號碼:</label>
                        <input type="text" class="field-input order-input" placeholder="必須12碼" 
                               value="${defaults.orderNo}" 
                               maxlength="12"
                               pattern="[A-ZX0-9]{12}" 
                               onkeyup="this.value = this.value.toUpperCase().replace(/[^A-ZX0-9]/g, '')" 
                               onchange="validateOrderNumber(this)" />
                    </div>
                    <div class="field-group">
                        <label class="field-label">件號:</label>
                        <input type="text" class="field-input part-input" placeholder="英文大寫+數字+破折號" 
                               value="${defaults.partNo}"
                               pattern="[A-ZX0-9-]+" 
                               onkeyup="this.value = this.value.toUpperCase().replace(/[^A-ZX0-9-]/g, '')" />
                    </div>
                    <div class="field-group">
                        <label class="field-label">製令數量:</label>
                        <input type="number" class="field-input qty-input" placeholder="0" value="${defaults.orderQty}" min="0" />
                    </div>
                    <div class="field-group">
                        <label class="field-label">良品:</label>
                        <input type="number" class="field-input good-input" placeholder="0" value="${defaults.good}" min="0" />
                    </div>
                    <div class="field-group">
                        <label class="field-label">不良品:</label>
                        <input type="number" class="field-input bad-input" placeholder="0" value="${defaults.bad}" min="0" />
                    </div>
                    <div class="field-group">
                        <label class="field-label">備註:</label>
                        <input type="text" class="field-input remark-input" placeholder="選填" value="${defaults.remark}" />
                    </div>
                </div>
                <div class="card-actions">
                    <button class="btn btn-copy" onclick="copyCard(this)">複製</button>
                </div>
            `;
            
            // 根據製程代號設定初始值
            const processSelect = card.querySelector('.process-select');
            const processValue = processSelect.value;
            // 只有特定選項會自動填入 XXXXXXXXXXXX
            if (['51', 'G', 'U1', 'U2', 'U3', 'U4', 'U5', 'U6', 'U7', 'U8', 'U10'].includes(processValue)) {
                card.querySelector('.order-input').value = 'XXXXXXXXXXXX';
                card.querySelector('.part-input').value = 'XXXXXXXXXXXX';
                
                // 如果是請假，機台自動選擇X
                if (processValue === 'U10') {
                    card.querySelector('.machine-select').value = 'X';
                }
            }
            
            return card;
        }

        // 處理製程代號變更
        function handleProcessChange(selectElement) {
            const card = selectElement.closest('.entry-card');
            const orderInput = card.querySelector('.order-input');
            const partInput = card.querySelector('.part-input');
            const machineSelect = card.querySelector('.machine-select');
            
            // 特定選項會自動填入
            if (['51', 'G', 'U1', 'U2', 'U3', 'U4', 'U5', 'U6', 'U7', 'U8', 'U10'].includes(selectElement.value)) {
                orderInput.value = 'XXXXXXXXXXXX';
                partInput.value = 'XXXXXXXXXXXX';
                
                // 如果是請假，機台自動選擇X
                if (selectElement.value === 'U10') {
                    machineSelect.value = 'X';
                }
            }
            // A, A1, AA1, B 都不自動填入，保持原值
            
            validateTime();
        }

        // 驗證製令號碼必須12位
        function validateOrderNumber(input) {
            if (input.value.length !== 12) {
                input.classList.add('invalid');
                showMessage('製令號碼必須為12位數', 'error');
            } else {
                input.classList.remove('invalid');
            }
        }

        // 複製時段卡片
        function copyCard(btn) {
            const originalCard = btn.closest('.entry-card');
            const endTime = originalCard.querySelector('.end-time').value;
            
            // 收集原卡片的所有資料
            const cardData = {
                startTime: endTime, // 開始時間接續上一個結束時間
                endTime: '', // 結束時間留空
                machine: originalCard.querySelector('.machine-select').value,
                process: originalCard.querySelector('.process-select').value,
                orderNo: originalCard.querySelector('.order-input').value,
                partNo: originalCard.querySelector('.part-input').value,
                orderQty: originalCard.querySelector('.qty-input').value,
                good: originalCard.querySelector('.good-input').value,
                bad: originalCard.querySelector('.bad-input').value,
                remark: originalCard.querySelector('.remark-input').value
            };
            
            // 創建新卡片並插入到原卡片後面
            const newCard = createTimeCard(cardData);
            originalCard.parentNode.insertBefore(newCard, originalCard.nextSibling);
            
            // 捲動到新卡片
            newCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
            
            validateTime();
        }

        // 新增時段行
        function addNewRow() {
            const container = document.getElementById('entriesContainer');
            const newCard = createTimeCard();
            container.appendChild(newCard);
            
            // 自動捲動到新增的卡片
            newCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        // 刪除時段卡片
        function deleteCard(btn) {
            if (document.querySelectorAll('.entry-card').length > 1) {
                btn.closest('.entry-card').remove();
                validateTime();
            } else {
                showMessage('至少需保留一個時段', 'error');
            }
        }

        // 填充掃地時間 - 優化版
        function fillSweepingTime() {
            const container = document.getElementById('entriesContainer');
            const existingCards = Array.from(container.querySelectorAll('.entry-card'));
            
            // 檢查是否已有掃地時間
            let hasSweepingTime = false;
            for (const card of existingCards) {
                const startTime = card.querySelector('.start-time').value;
                const endTime = card.querySelector('.end-time').value;
                const process = card.querySelector('.process-select').value;
                
                if (startTime === '08:00' && endTime === '08:15' && process === '51') {
                    hasSweepingTime = true;
                    showMessage('掃地時間已存在', 'error');
                    return;
                }
            }
            
            // 如果沒有任何時段，直接新增掃地時間
            if (existingCards.length === 0 || 
                (existingCards.length === 1 && !existingCards[0].querySelector('.start-time').value)) {
                // 清空容器
                container.innerHTML = '';
                entryCount = 0;
                
                // 新增掃地時間
                const sweepCard = createTimeCard({
                    startTime: '08:00',
                    endTime: '08:15',
                    machine: 'X',
                    process: '51',
                    orderNo: 'XXXXXXXXXXXX',
                    partNo: 'XXXXXXXXXXXX',
                    orderQty: '0',
                    good: '0',
                    bad: '0',
                    remark: ''
                });
                container.appendChild(sweepCard);
                showMessage('已新增掃地時間 (8:00-8:15)', 'success');
                validateTime();
                return;
            }
            
            // 處理已有8:00開始的時段
            let processedCards = [];
            let sweepingInserted = false;
            
            for (const card of existingCards) {
                const startTime = card.querySelector('.start-time').value;
                const endTime = card.querySelector('.end-time').value;
                
                if (startTime === '08:00') {
                    if (!sweepingInserted) {
                        // 插入掃地時間
                        const sweepCard = createTimeCard({
                            startTime: '08:00',
                            endTime: '08:15',
                            machine: 'X',
                            process: '51',
                            orderNo: 'XXXXXXXXXXXX',
                            partNo: 'XXXXXXXXXXXX',
                            orderQty: '0',
                            good: '0',
                            bad: '0',
                            remark: ''
                        });
                        processedCards.push(sweepCard);
                        sweepingInserted = true;
                        
                        // 處理原有的8:00時段
                        if (endTime > '08:15') {
                            // 修改原時段為8:15開始
                            const modifiedCard = createTimeCard({
                                startTime: '08:15',
                                endTime: endTime,
                                machine: card.querySelector('.machine-select').value,
                                process: card.querySelector('.process-select').value,
                                orderNo: card.querySelector('.order-input').value,
                                partNo: card.querySelector('.part-input').value,
                                orderQty: card.querySelector('.qty-input').value,
                                good: card.querySelector('.good-input').value,
                                bad: card.querySelector('.bad-input').value,
                                remark: card.querySelector('.remark-input').value
                            });
                            processedCards.push(modifiedCard);
                        }
                        // 如果結束時間<=08:15，該時段被完全取代，不再加入
                    }
                } else {
                    // 保留其他時段
                    const clonedCard = createTimeCard({
                        startTime: startTime,
                        endTime: endTime,
                        machine: card.querySelector('.machine-select').value,
                        process: card.querySelector('.process-select').value,
                        orderNo: card.querySelector('.order-input').value,
                        partNo: card.querySelector('.part-input').value,
                        orderQty: card.querySelector('.qty-input').value,
                        good: card.querySelector('.good-input').value,
                        bad: card.querySelector('.bad-input').value,
                        remark: card.querySelector('.remark-input').value
                    });
                    processedCards.push(clonedCard);
                }
            }
            
            // 如果沒有8:00的時段，在最前面插入掃地時間
            if (!sweepingInserted) {
                const sweepCard = createTimeCard({
                    startTime: '08:00',
                    endTime: '08:15',
                    machine: 'X',
                    process: '51',
                    orderNo: 'XXXXXXXXXXXX',
                    partNo: 'XXXXXXXXXXXX',
                    orderQty: '0',
                    good: '0',
                    bad: '0',
                    remark: ''
                });
                processedCards.unshift(sweepCard);
            }
            
            // 重新填充容器
            container.innerHTML = '';
            entryCount = 0;
            processedCards.forEach(card => container.appendChild(card));
            
            showMessage('已新增掃地時間 (8:00-8:15)', 'success');
            validateTime();
        }

        // 清空所有
        function clearAll() {
            const container = document.getElementById('entriesContainer');
            container.innerHTML = '';
            entryCount = 0;
            addNewRow();
            showMessage('已清空所有時段', 'success');
        }

        // 跳轉到錯誤位置
        function jumpToError(type) {
            const statusItem = document.getElementById(`${type}StatusItem`);
            
            // 只有在錯誤狀態下才跳轉
            if (!statusItem.classList.contains('error')) {
                return;
            }
            
            const cards = errorCards[type];
            if (cards && cards.length > 0) {
                const firstErrorCard = document.querySelector(`[data-card-id="${cards[0]}"]`);
                if (firstErrorCard) {
                    // 移除所有highlight
                    document.querySelectorAll('.entry-card').forEach(card => {
                        card.classList.remove('highlight');
                    });
                    
                    // 加上highlight
                    firstErrorCard.classList.add('highlight');
                    
                    // 跳轉到該卡片
                    firstErrorCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    
                    // 3秒後移除highlight
                    setTimeout(() => {
                        firstErrorCard.classList.remove('highlight');
                    }, 3000);
                }
            }
        }

        // 計算時間差（分鐘）
        function calculateMinutes(startTime, endTime) {
            if (!startTime || !endTime) return 0;
            
            const start = new Date(`2000-01-01T${startTime}:00`);
            const end = new Date(`2000-01-01T${endTime}:00`);
            
            const diff = end - start;
            return Math.round(diff / 60000); // 轉換為分鐘
        }

        // 驗證時間和資料完整性
        function validateTime() {
            const cards = document.querySelectorAll('.entry-card');
            let morningCovered = false;
            let afternoonCovered = false;
            let totalMinutes = 0;
            let dataComplete = true;
            let hasLunchTimeError = false;
            
            const timeSegments = [];
            
            // 重置錯誤記錄
            errorCards = {
                morning: [],
                afternoon: [],
                data: []
            };
            
            cards.forEach(card => {
                const cardId = card.getAttribute('data-card-id');
                const startTime = card.querySelector('.start-time').value;
                const endTime = card.querySelector('.end-time').value;
                const machine = card.querySelector('.machine-select').value;
                const orderNo = card.querySelector('.order-input').value;
                
                // 重置錯誤狀態
                card.classList.remove('error');
                card.querySelectorAll('.field-input').forEach(input => {
                    input.classList.remove('invalid');
                });
                
                // 檢查是否有12:00-13:00的時段
                if (startTime && endTime) {
                    if ((startTime >= '12:00' && startTime < '13:00') || 
                        (endTime > '12:00' && endTime <= '13:00')) {
                        hasLunchTimeError = true;
                        card.classList.add('error');
                        errorCards.data.push(cardId);
                        showMessage('⚠️ 警告：12:00-13:00為休息時間，請確認時間是否填寫正確', 'error');
                    }
                    
                    // 計算總工作時數
                    totalMinutes += calculateMinutes(startTime, endTime);
                }
                
                if (startTime && endTime && !hasLunchTimeError) {
                    timeSegments.push({
                        start: startTime, 
                        end: endTime,
                        cardId: cardId
                    });
                    
                    // 檢查上午時段覆蓋 (8:00-12:00)
                    if (startTime <= '08:00' && endTime >= '12:00') {
                        morningCovered = true;
                    } else if (startTime < '12:00' && endTime > '08:00') {
                        morningCovered = checkFullCoverage(timeSegments, '08:00', '12:00');
                    }
                    
                    // 檢查下午時段覆蓋 (13:00-17:00)
                    if (startTime <= '13:00' && endTime >= '17:00') {
                        afternoonCovered = true;
                    } else if (startTime < '17:00' && endTime > '13:00') {
                        afternoonCovered = checkFullCoverage(timeSegments, '13:00', '17:00');
                    }
                }
                
                // 檢查必填欄位（機台和製令號碼）
                if (startTime && endTime && (!machine || !orderNo)) {
                    dataComplete = false;
                    errorCards.data.push(cardId);
                    if (!machine) card.querySelector('.machine-select').classList.add('invalid');
                    if (!orderNo) card.querySelector('.order-input').classList.add('invalid');
                }
                
                // 檢查製令號碼是否為12位
                if (orderNo && orderNo.length !== 12) {
                    dataComplete = false;
                    errorCards.data.push(cardId);
                    card.querySelector('.order-input').classList.add('invalid');
                }
            });
            
            // 找出未覆蓋的時段
            if (!morningCovered) {
                errorCards.morning = findUncoveredCards(timeSegments, '08:00', '12:00');
            }
            if (!afternoonCovered) {
                errorCards.afternoon = findUncoveredCards(timeSegments, '13:00', '17:00');
            }
            
            // 計算工時狀態
            const workHours = Math.floor(totalMinutes / 60);
            const workMinutes = totalMinutes % 60;
            const isWorkHoursComplete = totalMinutes >= 480; // 8小時 = 480分鐘
            
            // 更新驗證狀態顯示
            updateStatus('morningStatus', 'morningText', 'morningStatusItem', 
                        morningCovered && !hasLunchTimeError, '上午時段已完整覆蓋', '上午時段未完整覆蓋');
            updateStatus('afternoonStatus', 'afternoonText', 'afternoonStatusItem',
                        afternoonCovered && !hasLunchTimeError, '下午時段已完整覆蓋', '下午時段未完整覆蓋');
            updateStatus('workHoursStatus', 'workHoursText', 'workHoursStatusItem',
                        isWorkHoursComplete, `工時已滿8小時（${workHours}小時${workMinutes}分）`, 
                        `工時不足8小時（目前${workHours}小時${workMinutes}分）`);
            updateStatus('dataStatus', 'dataText', 'dataStatusItem',
                        dataComplete && !hasLunchTimeError, '資料填寫完整', 
                        hasLunchTimeError ? '12:00-13:00為休息時間' : '機台或製令號未填寫');
            
            return morningCovered && afternoonCovered && isWorkHoursComplete && dataComplete && !hasLunchTimeError;
        }

        function checkFullCoverage(segments, requiredStart, requiredEnd) {
            segments.sort((a, b) => a.start.localeCompare(b.start));
            
            let currentTime = requiredStart;
            for (const segment of segments) {
                if (segment.start <= currentTime && segment.end > currentTime) {
                    currentTime = segment.end;
                    if (currentTime >= requiredEnd) {
                        return true;
                    }
                }
            }
            return false;
        }

        function findUncoveredCards(segments, requiredStart, requiredEnd) {
            const uncoveredCards = [];
            segments.forEach(segment => {
                // 如果時段在要求範圍內但沒有完全覆蓋
                if ((segment.start >= requiredStart && segment.start < requiredEnd) ||
                    (segment.end > requiredStart && segment.end <= requiredEnd)) {
                    uncoveredCards.push(segment.cardId);
                }
            });
            
            // 如果沒有任何時段在範圍內，返回第一個卡片
            if (uncoveredCards.length === 0 && segments.length > 0) {
                uncoveredCards.push(segments[0].cardId);
            }
            
            return uncoveredCards;
        }

        function updateStatus(iconId, textId, itemId, isValid, successText, errorText) {
            const icon = document.getElementById(iconId);
            const text = document.getElementById(textId);
            const item = document.getElementById(itemId);
            
            if (isValid) {
                icon.className = 'status-icon success';
                icon.textContent = '✓';
                text.textContent = successText;
                item.classList.remove('error');
            } else {
                icon.className = 'status-icon error';
                icon.textContent = '✗';
                text.textContent = errorText;
                item.classList.add('error');
            }
        }

        // 驗證並儲存
        function validateAndSave() {
            // 檢查員工資訊
            const employeeId = document.getElementById('employeeId').value;
            const employeeName = document.getElementById('employeeName').value;
            
            if (!employeeId || !employeeName) {
                showMessage('請填寫員工編號和姓名', 'error');
                
                // 跳到未填寫的欄位
                if (!employeeId) {
                    document.getElementById('employeeId').scrollIntoView({ behavior: 'smooth', block: 'center' });
                    document.getElementById('employeeId').focus();
                    document.getElementById('employeeId').classList.add('shake');
                    setTimeout(() => {
                        document.getElementById('employeeId').classList.remove('shake');
                    }, 500);
                } else if (!employeeName) {
                    document.getElementById('employeeName').scrollIntoView({ behavior: 'smooth', block: 'center' });
                    document.getElementById('employeeName').focus();
                    document.getElementById('employeeName').classList.add('shake');
                    setTimeout(() => {
                        document.getElementById('employeeName').classList.remove('shake');
                    }, 500);
                }
                return;
            }
            
            // 驗證時間和資料
            if (!validateTime()) {
                // 找到第一個有錯誤的欄位並跳轉
                const firstInvalid = document.querySelector('.invalid');
                if (firstInvalid) {
                    firstInvalid.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    firstInvalid.focus();
                    firstInvalid.classList.add('shake');
                    setTimeout(() => {
                        firstInvalid.classList.remove('shake');
                    }, 500);
                }
                
                showMessage('❌ 驗證失敗！請檢查標記紅色的欄位', 'error');
                return;
            }
            
            // 儲存員工資料到本地儲存
            saveEmployeeData();
            
            // 模擬儲存到後端
            showMessage('✅ 驗證通過！日報表已成功儲存', 'success');
            
            // 模擬儲存動畫
            document.querySelector('.btn-primary').classList.add('pulse');
            setTimeout(() => {
                document.querySelector('.btn-primary').classList.remove('pulse');
            }, 2000);
        }

        // 取得星期幾的中文
        function getChineseDayOfWeek(date) {
            const days = ['日', '一', '二', '三', '四', '五', '六'];
            return days[date.getDay()];
        }

        // 轉換時間格式 (08:00 -> 0800)
        function formatTimeForExcel(timeStr) {
            if (!timeStr) return '';
            return timeStr.replace(':', '');
        }

        // 西元年轉民國年
        function toROCYear(date) {
            return date.getFullYear() - 1911;
        }

        // 收集報表數據
        function collectReportData() {
            const reportDate = new Date(document.getElementById('reportDate').value);
            const employeeName = document.getElementById('employeeName').value;
            const cards = document.querySelectorAll('.entry-card');
            
            const data = [];
            
            cards.forEach(card => {
                const startTime = card.querySelector('.start-time').value;
                const endTime = card.querySelector('.end-time').value;
                const machine = card.querySelector('.machine-select').value;
                const processCode = card.querySelector('.process-select').value;
                const orderNo = card.querySelector('.order-input').value;
                const partNo = card.querySelector('.part-input').value;
                const orderQty = card.querySelector('.qty-input').value || '0';
                const good = card.querySelector('.good-input').value || '0';
                const bad = card.querySelector('.bad-input').value || '0';
                const remark = card.querySelector('.remark-input').value || '';
                
                if (startTime && endTime) {
                    data.push({
                        year: toROCYear(reportDate),
                        month: reportDate.getMonth() + 1,
                        day: reportDate.getDate(),
                        weekday: getChineseDayOfWeek(reportDate),
                        unit: '加工部',
                        employee: employeeName,
                        startTime: formatTimeForExcel(startTime),
                        machine: machine,
                        processCode: processCode,
                        orderNo: orderNo,
                        partNo: partNo,
                        orderQty: orderQty,
                        good: good,
                        bad: bad,
                        endTime: formatTimeForExcel(endTime),
                        remark: remark,
                        minutes: calculateMinutes(startTime, endTime)
                    });
                }
            });
            
            return data;
        }

        // 初始化觸控縮放
        function initTouchZoom() {
            const modalBody = document.querySelector('.modal-body');
            const previewContent = document.querySelector('.preview-content');
            
            let lastDistance = 0;
            let initialDistance = 0;
            
            modalBody.addEventListener('touchstart', function(e) {
                if (e.touches.length === 2) {
                    initialDistance = getDistance(e.touches[0], e.touches[1]);
                    lastDistance = initialDistance;
                }
            });
            
            modalBody.addEventListener('touchmove', function(e) {
                if (e.touches.length === 2) {
                    const currentDistance = getDistance(e.touches[0], e.touches[1]);
                    const scale = currentDistance / initialDistance;
                    
                    currentScale = Math.min(Math.max(0.5, scale), 3);
                    previewContent.style.transform = `scale(${currentScale})`;
                    
                    lastDistance = currentDistance;
                }
            });
            
            function getDistance(touch1, touch2) {
                const dx = touch1.clientX - touch2.clientX;
                const dy = touch1.clientY - touch2.clientY;
                return Math.sqrt(dx * dx + dy * dy);
            }
        }

        // 更新表格資料
        function updateTableData(row, field, value) {
            const cardIndex = parseInt(row.getAttribute('data-row-index'));
            const cards = document.querySelectorAll('.entry-card');
            
            if (cards[cardIndex]) {
                const card = cards[cardIndex];
                
                // 根據欄位更新對應的輸入框
                switch(field) {
                    case 'startTime':
                        card.querySelector('.start-time').value = value.length === 4 ? 
                            value.substring(0,2) + ':' + value.substring(2,4) : value;
                        break;
                    case 'endTime':
                        card.querySelector('.end-time').value = value.length === 4 ? 
                            value.substring(0,2) + ':' + value.substring(2,4) : value;
                        break;
                    case 'machine':
                        card.querySelector('.machine-select').value = value;
                        break;
                    case 'processCode':
                        card.querySelector('.process-select').value = value;
                        break;
                    case 'orderNo':
                        card.querySelector('.order-input').value = value;
                        break;
                    case 'partNo':
                        card.querySelector('.part-input').value = value;
                        break;
                    case 'orderQty':
                        card.querySelector('.qty-input').value = value;
                        break;
                    case 'good':
                        card.querySelector('.good-input').value = value;
                        break;
                    case 'bad':
                        card.querySelector('.bad-input').value = value;
                        break;
                    case 'remark':
                        card.querySelector('.remark-input').value = value;
                        break;
                }
            }
        }

        // 預覽報表
        function previewReport() {
            if (!validateTime()) {
                showMessage('請先修正驗證錯誤', 'error');
                return;
            }
            
            const employeeName = document.getElementById('employeeName').value || '未填寫';
            const employeeId = document.getElementById('employeeId').value || '未填寫';
            const reportDate = document.getElementById('reportDate').value;
            const data = collectReportData();
            
            // 計算統計資料
            let totalGood = 0;
            let totalBad = 0;
            let totalMinutes = 0;
            
            data.forEach(row => {
                totalGood += parseInt(row.good) || 0;
                totalBad += parseInt(row.bad) || 0;
                totalMinutes += parseInt(row.minutes) || 0;
            });
            
            const totalRate = totalGood > 0 ? ((totalGood / (totalGood + totalBad)) * 100).toFixed(1) : 0;
            const totalHours = Math.floor(totalMinutes / 60);
            const remainMinutes = totalMinutes % 60;
            
            // 建立預覽HTML（可編輯版）
            let previewHTML = `
                <div class="summary-info">
                    <div class="summary-item">
                        <span class="summary-label">員工編號：</span>
                        <span class="summary-value">${employeeId}</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">員工姓名：</span>
                        <span class="summary-value">${employeeName}</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">報表日期：</span>
                        <span class="summary-value">${reportDate}</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">部門：</span>
                        <span class="summary-value">加工部</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">總良品數：</span>
                        <span class="summary-value">${totalGood}</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">總不良品數：</span>
                        <span class="summary-value">${totalBad}</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">良率：</span>
                        <span class="summary-value">${totalRate}%</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">總工時：</span>
                        <span class="summary-value">${totalHours}小時${remainMinutes}分鐘</span>
                    </div>
                </div>
                
                <h3>📋 詳細時段記錄（可直接編輯）</h3>
                <div style="overflow-x: auto;">
                    <table class="preview-table">
                        <thead>
                            <tr>
                                <th>工作起</th>
                                <th>工作迄</th>
                                <th>分鐘</th>
                                <th>設備編號</th>
                                <th>製程代號</th>
                                <th>製令單號</th>
                                <th>品號</th>
                                <th>製令數</th>
                                <th>良品</th>
                                <th>不良品</th>
                                <th>備註</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            data.forEach((row, index) => {
                previewHTML += `
                    <tr data-row-index="${index}">
                        <td><input type="text" value="${row.startTime}" onchange="updateTableData(this.closest('tr'), 'startTime', this.value)"></td>
                        <td><input type="text" value="${row.endTime}" onchange="updateTableData(this.closest('tr'), 'endTime', this.value)"></td>
                        <td>${row.minutes}</td>
                        <td><input type="text" value="${row.machine}" onchange="updateTableData(this.closest('tr'), 'machine', this.value)"></td>
                        <td><input type="text" value="${row.processCode}" onchange="updateTableData(this.closest('tr'), 'processCode', this.value)"></td>
                        <td><input type="text" value="${row.orderNo}" onchange="updateTableData(this.closest('tr'), 'orderNo', this.value)"></td>
                        <td><input type="text" value="${row.partNo}" onchange="updateTableData(this.closest('tr'), 'partNo', this.value)"></td>
                        <td><input type="text" value="${row.orderQty}" onchange="updateTableData(this.closest('tr'), 'orderQty', this.value)"></td>
                        <td><input type="text" value="${row.good}" onchange="updateTableData(this.closest('tr'), 'good', this.value)"></td>
                        <td><input type="text" value="${row.bad}" onchange="updateTableData(this.closest('tr'), 'bad', this.value)"></td>
                        <td><input type="text" value="${row.remark}" onchange="updateTableData(this.closest('tr'), 'remark', this.value)"></td>
                    </tr>
                `;
            });
            
            previewHTML += `
                        </tbody>
                    </table>
                </div>
            `;
            
            // 顯示Modal
            document.getElementById('modalBody').innerHTML = previewHTML;
            document.getElementById('previewModal').style.display = 'block';
            currentScale = 1;
            document.querySelector('.preview-content').style.transform = 'scale(1)';
        }

        // 關閉預覽Modal
        function closePreviewModal() {
            document.getElementById('previewModal').style.display = 'none';
            // 關閉時重新驗證
            validateTime();
        }

        // 點擊Modal外部關閉
        window.onclick = function(event) {
            const modal = document.getElementById('previewModal');
            if (event.target == modal) {
                modal.style.display = 'none';
                validateTime();
            }
        }

        // 匯出Excel
        function exportToExcel() {
            if (!validateTime()) {
                showMessage('請先修正驗證錯誤', 'error');
                
                const firstInvalid = document.querySelector('.invalid');
                if (firstInvalid) {
                    firstInvalid.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    firstInvalid.focus();
                }
                return;
            }
            
            const employeeName = document.getElementById('employeeName').value;
            if (!employeeName) {
                showMessage('請填寫員工姓名', 'error');
                return;
            }
            
            showMessage('正在生成Excel報表...', 'success');
            
            const data = collectReportData();
            
            // 準備Excel資料（刪除製程、品名規格、分鐘欄位）
            const wsData = [
                ['年', '月', '日', '星期', '單位', '人員', '工作起', '設備編號', '製程代號', 
                 '製令單號', '品號', '製令數', '良品', '不良品', '工作迄', '備註']
            ];
            
            data.forEach(row => {
                wsData.push([
                    row.year,
                    row.month,
                    row.day,
                    row.weekday,
                    row.unit,
                    row.employee,
                    row.startTime,
                    row.machine,
                    row.processCode,
                    row.orderNo,
                    row.partNo,
                    row.orderQty,
                    row.good,
                    row.bad,
                    row.endTime,
                    row.remark
                ]);
            });
            
            // 建立工作表
            const ws = XLSX.utils.aoa_to_sheet(wsData);
            
            // 設定欄寬
            ws['!cols'] = [
                { wch: 5 },  // 年
                { wch: 5 },  // 月
                { wch: 5 },  // 日
                { wch: 6 },  // 星期
                { wch: 8 },  // 單位
                { wch: 10 }, // 人員
                { wch: 8 },  // 工作起
                { wch: 12 }, // 設備編號
                { wch: 10 }, // 製程代號
                { wch: 15 }, // 製令單號
                { wch: 20 }, // 品號
                { wch: 8 },  // 製令數
                { wch: 6 },  // 良品
                { wch: 8 },  // 不良品
                { wch: 8 },  // 工作迄
                { wch: 20 }  // 備註
            ];
            
            // 設定儲存格顏色
            const range = XLSX.utils.decode_range(ws['!ref']);
            for (let R = 0; R <= range.e.r; ++R) {
                for (let C = 0; C <= range.e.c; ++C) {
                    const cell_address = {c: C, r: R};
                    const cell_ref = XLSX.utils.encode_cell(cell_address);
                    
                    if (!ws[cell_ref]) continue;
                    
                    // 初始化儲存格樣式
                    if (!ws[cell_ref].s) ws[cell_ref].s = {};
                    
                    // 設定填充顏色
                    if (C >= 0 && C <= 8) {
                        // A-I欄：藍色
                        ws[cell_ref].s.fill = {
                            patternType: "solid",
                            fgColor: { rgb: "B8CCE4" }
                        };
                    } else if (C >= 9 && C <= 10) {
                        // J-K欄：綠色
                        ws[cell_ref].s.fill = {
                            patternType: "solid",
                            fgColor: { rgb: "C4D79B" }
                        };
                    } else if (C >= 11 && C <= 13) {
                        // L-N欄：黃色
                        ws[cell_ref].s.fill = {
                            patternType: "solid",
                            fgColor: { rgb: "FFFF99" }
                        };
                    } else if (C === 14) {
                        // O欄：灰色
                        ws[cell_ref].s.fill = {
                            patternType: "solid",
                            fgColor: { rgb: "D9D9D9" }
                        };
                    }
                    // P欄（備註）不填色
                }
            }
            
            // 建立活頁簿
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, '日報表');
            
            // 生成檔名
            const reportDate = document.getElementById('reportDate').value.replace(/-/g, '');
            const fileName = `${employeeName}_${reportDate}.xlsx`;
            
            // 下載檔案
            XLSX.writeFile(wb, fileName);
            
            setTimeout(() => {
                showMessage(`Excel報表已生成並下載！檔名：${fileName}`, 'success');
            }, 500);
        }

        // 顯示訊息
        function showMessage(text, type) {
            const messageBox = document.getElementById('messageBox');
            messageBox.textContent = text;
            messageBox.className = `message ${type}`;
            
            setTimeout(() => {
                messageBox.className = 'message';
            }, 3000);
        }

        // 初始化
        window.onload = function() {
            initDateTime();
            loadEmployeeData();
            addNewRow();
        }
    </script>
</body>
</html>
