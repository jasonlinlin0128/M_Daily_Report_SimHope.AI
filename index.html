 <!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŠ å·¥éƒ¨é–€æ•¸ä½æ—¥å ±è¡¨ç³»çµ± v7.0</title>
    <!-- å¼•å…¥SheetJS for Excel export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            overflow-x: hidden;
        }

        .container {
            max-width: 100%;
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 32px;
            margin-bottom: 10px;
        }

        .header .date-info {
            font-size: 18px;
            opacity: 0.9;
        }

        .main-content {
            padding: 30px;
            overflow-x: hidden;
        }

        .employee-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .employee-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
        }

        .input-group label {
            font-weight: bold;
            color: #495057;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .input-group input, .input-group select {
            padding: 10px;
            border: 2px solid #dee2e6;
            border-radius: 5px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .input-group input:focus, .input-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .fixed-department {
            padding: 10px;
            background: #e9ecef;
            border: 2px solid #dee2e6;
            border-radius: 5px;
            font-size: 16px;
            font-weight: bold;
        }

        .time-entries {
            margin-top: 30px;
        }

        .time-entries h3 {
            color: #495057;
            margin-bottom: 15px;
            font-size: 20px;
        }

        .entries-container {
            padding: 10px;
            background: #f8f9fa;
            border-radius: 10px;
            overflow-x: auto;
            overflow-y: visible;
        }

        .entry-card {
            background: white;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            transition: all 0.3s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            overflow-x: auto;
            position: relative;
        }

        .entry-card:hover {
            border-color: #667eea;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.2);
        }

        .entry-card.error {
            border-color: #dc3545;
            background: #fff5f5;
        }

        .entry-card.highlight {
            border-color: #ffc107;
            background: #fffbf0;
            animation: pulse 1s 2;
        }

        .entry-card-header {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            margin-bottom: 15px;
            gap: 10px;
        }

        .entry-fields {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            width: 100%;
        }

        .field-group {
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 0;
        }

        .field-label {
            min-width: 80px;
            font-weight: bold;
            color: #495057;
            font-size: 14px;
            text-align: right;
            flex-shrink: 0;
        }

        .field-input {
            flex: 1;
            padding: 8px;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            font-size: 14px;
            min-width: 0;
        }

        .field-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
        }

        .field-input.invalid {
            border-color: #dc3545;
            background: #fff5f5;
        }

        .field-input[readonly] {
            background: #e9ecef;
            cursor: not-allowed;
        }

        .card-actions {
            display: flex;
            justify-content: flex-end;
            margin-top: 15px;
            gap: 10px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
            white-space: nowrap;
        }

        .btn-add {
            background: #28a745;
            color: white;
            margin-top: 10px;
        }

        .btn-add:hover {
            background: #218838;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
        }

        .btn-delete {
            background: #dc3545;
            color: white;
            padding: 8px 15px;
        }

        .btn-delete:hover {
            background: #c82333;
        }

        .btn-copy {
            background: #007bff;
            color: white;
            padding: 8px 15px;
        }

        .btn-copy:hover {
            background: #0056b3;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 30px;
            font-size: 16px;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .validation-section {
            margin-top: 30px;
            padding: 20px;
            background: #e8f4f8;
            border-radius: 10px;
            border-left: 5px solid #17a2b8;
        }

        .validation-section h3 {
            color: #17a2b8;
            margin-bottom: 15px;
        }

        .validation-status {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }

        .status-item {
            padding: 15px;
            background: white;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .status-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .status-item.error {
            border: 2px solid #dc3545;
        }

        .status-item.error:hover {
            background: #fff5f5;
        }

        .status-icon {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .status-icon.success {
            background: #28a745;
            color: white;
        }

        .status-icon.error {
            background: #dc3545;
            color: white;
        }

        .status-icon.warning {
            background: #ffc107;
            color: white;
        }

        .actions {
            margin-top: 30px;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
        }

        .quick-fill {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .btn-quick {
            background: #6c757d;
            color: white;
        }

        .btn-quick:hover {
            background: #5a6268;
        }

        .btn-sweep {
            background: #17a2b8;
            color: white;
        }

        .btn-sweep:hover {
            background: #138496;
        }

        .message {
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            display: none;
            animation: slideDown 0.3s ease-out;
        }

        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            display: block;
        }

        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            display: block;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            overflow: auto;
        }

        .modal-content {
            background-color: #fefefe;
            margin: 2% auto;
            padding: 0;
            border: 1px solid #888;
            width: 95%;
            max-width: 1600px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            margin: 0;
        }

        .modal-body {
            padding: 20px;
            overflow: auto;
            flex: 1;
            touch-action: pinch-zoom;
            -webkit-overflow-scrolling: touch;
        }

        .modal-close {
            color: white;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            background: none;
            border: none;
            padding: 0;
            line-height: 1;
        }

        .modal-close:hover {
            opacity: 0.7;
        }

        .preview-content {
            transform-origin: center;
            transition: transform 0.2s;
            touch-action: manipulation;
            min-width: 100%;
        }

        .preview-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .preview-table th, .preview-table td {
            border: 1px solid #dee2e6;
            padding: 10px;
            text-align: left;
            white-space: nowrap;
        }

        .preview-table th {
            background: #f8f9fa;
            font-weight: bold;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .preview-table tbody tr:hover {
            background: #f1f3f5;
        }

        .preview-table td input {
            width: 100%;
            min-width: 80px;
            border: 1px solid transparent;
            background: transparent;
            padding: 5px;
        }

        .preview-table td input:focus {
            border: 1px solid #667eea;
            background: white;
            outline: none;
        }

        .summary-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .summary-label {
            font-weight: bold;
            color: #495057;
        }

        .summary-value {
            color: #667eea;
            font-weight: bold;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
            100% {
                transform: scale(1);
            }
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .shake {
            animation: shake 0.5s;
        }

        .required-mark {
            color: #dc3545;
            font-weight: bold;
        }

        .memory-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            background: #28a745;
            border-radius: 50%;
            margin-left: 5px;
            animation: pulse 2s infinite;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 24px;
            }
            
            .entry-fields {
                grid-template-columns: 1fr;
            }
            
            .field-label {
                min-width: 70px;
                font-size: 12px;
            }
            
            .actions {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }
            
            .modal-content {
                width: 98%;
                margin: 1% auto;
            }

            .preview-table {
                font-size: 12px;
            }

            .preview-table th, .preview-table td {
                padding: 5px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ­ åŠ å·¥éƒ¨é–€æ•¸ä½æ—¥å ±è¡¨ç³»çµ± v7.0</h1>
            <div class="date-info">
                <span id="currentDate"></span> | 
                <span id="currentTime"></span>
            </div>
        </div>

        <div class="main-content">
            <div class="employee-section">
                <div class="employee-info">
                    <div class="input-group">
                        <label for="employeeId">
                            å“¡å·¥ç·¨è™Ÿ <span class="required-mark">*</span>
                            <span id="memoryIndicatorId" class="memory-indicator" style="display:none" title="å·²è¨˜æ†¶"></span>
                        </label>
                        <input type="text" id="employeeId" placeholder="ä¾‹ï¼šE001" />
                    </div>
                    <div class="input-group">
                        <label for="employeeName">
                            å“¡å·¥å§“å <span class="required-mark">*</span>
                            <span id="memoryIndicatorName" class="memory-indicator" style="display:none" title="å·²è¨˜æ†¶"></span>
                        </label>
                        <input type="text" id="employeeName" placeholder="è«‹è¼¸å…¥å§“å" />
                    </div>
                    <div class="input-group">
                        <label for="department">éƒ¨é–€</label>
                        <div class="fixed-department">åŠ å·¥éƒ¨</div>
                    </div>
                    <div class="input-group">
                        <label for="reportDate">å ±è¡¨æ—¥æœŸ <span class="required-mark">*</span></label>
                        <input type="date" id="reportDate" />
                    </div>
                </div>
            </div>

            <div class="time-entries">
                <h3>ğŸ“ å·¥ä½œæ™‚æ®µè¨˜éŒ„</h3>
                
                <div class="quick-fill">
                    <button class="btn btn-sweep" onclick="fillSweepingTime()">
                        ğŸ§¹ æƒåœ°æ™‚é–“ (8:00-8:15)
                    </button>
                    <button class="btn btn-quick" onclick="clearAll()">
                        ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰
                    </button>
                </div>

                <div class="entries-container" id="entriesContainer">
                    <!-- å‹•æ…‹ç”Ÿæˆçš„æ™‚æ®µå¡ç‰‡å°‡æ’å…¥é€™è£¡ -->
                </div>
                
                <button class="btn btn-add" onclick="addNewRow()">
                    â• æ–°å¢æ™‚æ®µ
                </button>
            </div>

            <div class="validation-section">
                <h3>âœ… æ™‚é–“é©—è­‰ç‹€æ…‹</h3>
                <div class="validation-status">
                    <div class="status-item" id="morningStatusItem" onclick="jumpToError('morning')">
                        <div class="status-icon" id="morningStatus">?</div>
                        <div>
                            <strong>ä¸Šåˆæ™‚æ®µ</strong><br>
                            <small id="morningText">å¾…é©—è­‰ (8:00-12:00)</small>
                        </div>
                    </div>
                    <div class="status-item" id="afternoonStatusItem" onclick="jumpToError('afternoon')">
                        <div class="status-icon" id="afternoonStatus">?</div>
                        <div>
                            <strong>ä¸‹åˆæ™‚æ®µ</strong><br>
                            <small id="afternoonText">å¾…é©—è­‰ (13:00-17:00)</small>
                        </div>
                    </div>
                    <div class="status-item" id="workHoursStatusItem">
                        <div class="status-icon" id="workHoursStatus">?</div>
                        <div>
                            <strong>ç¼ºå°‘å·¥ä½œæ™‚æ®µ</strong><br>
                            <small id="workHoursText">å¾…è¨ˆç®—ï¼ˆéœ€æ»¿8å°æ™‚ï¼‰</small>
                        </div>
                    </div>
                    <div class="status-item" id="dataStatusItem" onclick="jumpToError('data')">
                        <div class="status-icon" id="dataStatus">?</div>
                        <div>
                            <strong>è³‡æ–™å®Œæ•´æ€§</strong><br>
                            <small id="dataText">å¾…é©—è­‰</small>
                        </div>
                    </div>
                </div>
            </div>

            <div id="messageBox" class="message"></div>

            <div class="actions">
                <button class="btn btn-primary" onclick="validateAndSave()">
                    ğŸ’¾ é©—è­‰ä¸¦å„²å­˜
                </button>
                <button class="btn btn-primary" onclick="exportToExcel()">
                    ğŸ“Š åŒ¯å‡ºExcel
                </button>
                <button class="btn btn-primary" onclick="previewReport()">
                    ğŸ‘ï¸ é è¦½å ±è¡¨
                </button>
            </div>
        </div>
    </div>

    <!-- Modal for Preview -->
    <div id="previewModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ğŸ“‹ å ±è¡¨é è¦½</h2>
                <button class="modal-close" onclick="closePreviewModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="modalBody" class="preview-content">
                    <!-- é è¦½å…§å®¹å°‡æ’å…¥é€™è£¡ -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // å…¨åŸŸè®Šæ•¸
        let entryCount = 0;
        let errorCards = {
            morning: [],
            afternoon: [],
            data: []
        };
        let currentScale = 1;
        let lastMachineSelection = '1.PC-55V';

        // è£½ç¨‹ä»£è™Ÿå°æ‡‰è¡¨
        const processMapping = {
            'A': 'é ˜æ–™/æº–å‚™/æ¶æ¨¡',
            'A1': 'æ›ç·š/ç¨‹å¼ç·¨å¯«',
            'AA1': 'æ¶æ¨¡/ç¨‹å¼',
            'B': 'åŠ å·¥',
            '51': 'æ¸…æ´—ï¼ˆæ¸…æ½”ï¼‰',
            'G': 'å»æ¯›é‚Š',
            'U1': 'æœƒè­°/è¨“ç·´',
            'U2': 'è¨­å‚™åœæ©Ÿ',
            'U3': 'åœå·¥å¾…æ–™',
            'U4': 'å“è³ªç¢ºèª',
            'U5': 'å·¥å‹™',
            'U6': 'ç²¾å¯¦å°ˆæ¡ˆ',
            'U7': 'é–‹æ²»å…·',
            'U8': 'å¾…æ©Ÿ',
            'U10': 'è«‹å‡'
        };

        // åˆå§‹åŒ–æ—¥æœŸå’Œæ™‚é–“
        function initDateTime() {
            const now = new Date();
            document.getElementById('reportDate').value = now.toISOString().split('T')[0];
            updateDateTime();
            setInterval(updateDateTime, 1000);
        }

        function updateDateTime() {
            const now = new Date();
            const dateStr = now.toLocaleDateString('zh-TW', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                weekday: 'long'
            });
            const timeStr = now.toLocaleTimeString('zh-TW');
            
            document.getElementById('currentDate').textContent = dateStr;
            document.getElementById('currentTime').textContent = timeStr;
        }

        // è¼‰å…¥è¨˜æ†¶çš„å“¡å·¥è³‡æ–™
        function loadEmployeeData() {
            const savedId = localStorage.getItem('employeeId');
            const savedName = localStorage.getItem('employeeName');
            
            if (savedId) {
                document.getElementById('employeeId').value = savedId;
                document.getElementById('memoryIndicatorId').style.display = 'inline-block';
            }
            
            if (savedName) {
                document.getElementById('employeeName').value = savedName;
                document.getElementById('memoryIndicatorName').style.display = 'inline-block';
            }
        }

        // å„²å­˜å“¡å·¥è³‡æ–™åˆ°æœ¬åœ°å„²å­˜
        function saveEmployeeData() {
            const employeeId = document.getElementById('employeeId').value;
            const employeeName = document.getElementById('employeeName').value;
            
            if (employeeId) {
                localStorage.setItem('employeeId', employeeId);
                document.getElementById('memoryIndicatorId').style.display = 'inline-block';
            }
            
            if (employeeName) {
                localStorage.setItem('employeeName', employeeName);
                document.getElementById('memoryIndicatorName').style.display = 'inline-block';
            }
        }

        // ç›£è½å“¡å·¥è³‡æ–™è®Šæ›´
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('employeeId').addEventListener('change', saveEmployeeData);
            document.getElementById('employeeName').addEventListener('change', saveEmployeeData);
            
            // åˆå§‹åŒ–è§¸æ§ç¸®æ”¾
            initTouchZoom();
        });

        // å–å¾—æœ€å¾Œä¸€ç­†è¨˜éŒ„çš„çµæŸæ™‚é–“
        function getLastEndTime() {
            const cards = document.querySelectorAll('.entry-card');
            if (cards.length === 0) return '';
            
            const lastCard = cards[cards.length - 1];
            const endTimeInput = lastCard.querySelector('.end-time');
            return endTimeInput ? endTimeInput.value : '';
        }

        // æ›´æ–°æœ€å¾Œé¸æ“‡çš„æ©Ÿå°
        function updateLastMachine(select) {
            lastMachineSelection = select.value;
        }

        // å‰µå»ºæ™‚æ®µå¡ç‰‡
        function createTimeCard(data = {}) {
            entryCount++;
            const cardNum = entryCount;
            
            // é è¨­å€¼ - ä½¿ç”¨æœ€å¾Œé¸æ“‡çš„æ©Ÿå°
            const defaults = {
                startTime: data.startTime || getLastEndTime() || '',
                endTime: data.endTime || '',
                machine: data.machine || lastMachineSelection,
                process: data.process || 'B',
                orderNo: data.orderNo || '',
                partNo: data.partNo || '',
                orderQty: data.orderQty || '',
                good: data.good || '',
                bad: data.bad || '0',
                remark: data.remark || ''
            };
            
            const card = document.createElement('div');
            card.className = 'entry-card';
            card.setAttribute('data-card-id', `card-${cardNum}`);
            card.innerHTML = `
                <div class="entry-card-header">
                    <button class="btn btn-delete" onclick="deleteCard(this)">åˆªé™¤</button>
                </div>
                <div class="entry-fields">
                    <div class="field-group">
                        <label class="field-label">é–‹å§‹:</label>
                        <input type="time" class="field-input start-time" value="${defaults.startTime}" onchange="validateTime()" />
                    </div>
                    <div class="field-group">
                        <label class="field-label">çµæŸ:</label>
                        <input type="time" class="field-input end-time" value="${defaults.endTime}" onchange="validateTime()" />
                    </div>
                    <div class="field-group">
                        <label class="field-label">ä½¿ç”¨æ©Ÿå°:</label>
                        <select class="field-input machine-select" onchange="updateLastMachine(this)">
                            <option value="1.PC-55V" ${defaults.machine === '1.PC-55V' ? 'selected' : ''}>1.PC-55V</option>
                            <option value="2.NC-2000" ${defaults.machine === '2.NC-2000' ? 'selected' : ''}>2.NC-2000</option>
                            <option value="3.BMC-80" ${defaults.machine === '3.BMC-80' ? 'selected' : ''}>3.BMC-80</option>
                            <option value="4.è»ŠåºŠ" ${defaults.machine === '4.è»ŠåºŠ' ? 'selected' : ''}>4.è»ŠåºŠ</option>
                            <option value="5.ä¸‰ç±³äº”é¢" ${defaults.machine === '5.ä¸‰ç±³äº”é¢' ? 'selected' : ''}>5.ä¸‰ç±³äº”é¢</option>
                            <option value="6.äº”ç±³äº”é¢" ${defaults.machine === '6.äº”ç±³äº”é¢' ? 'selected' : ''}>6.äº”ç±³äº”é¢</option>
                            <option value="7.BF-130" ${defaults.machine === '7.BF-130' ? 'selected' : ''}>7.BF-130</option>
                            <option value="8.A+2100" ${defaults.machine === '8.A+2100' ? 'selected' : ''}>8.A+2100</option>
                            <option value="9.ç¨‹å¼ç·¨å¯«" ${defaults.machine === '9.ç¨‹å¼ç·¨å¯«' ? 'selected' : ''}>9.ç¨‹å¼ç·¨å¯«</option>
                            <option value="X" ${defaults.machine === 'X' ? 'selected' : ''}>X</option>
                        </select>
                    </div>
                    <div class="field-group">
                        <label class="field-label">è£½ç¨‹ä»£è™Ÿ:</label>
                        <select class="field-input process-select" onchange="handleProcessChange(this)">
                            <option value="A" ${defaults.process === 'A' ? 'selected' : ''}>A(é ˜æ–™/æº–å‚™/æ¶æ¨¡)</option>
                            <option value="A1" ${defaults.process === 'A1' ? 'selected' : ''}>A1(æ›ç·š/ç¨‹å¼ç·¨å¯«)</option>
                            <option value="AA1" ${defaults.process === 'AA1' ? 'selected' : ''}>AA1(æ¶æ¨¡/ç¨‹å¼)</option>
                            <option value="B" ${defaults.process === 'B' ? 'selected' : ''}>B(åŠ å·¥)</option>
                            <option value="51" ${defaults.process === '51' ? 'selected' : ''}>51(æ¸…æ´—ï¼ˆæ¸…æ½”ï¼‰)</option>
                            <option value="G" ${defaults.process === 'G' ? 'selected' : ''}>G(å»æ¯›é‚Š)</option>
                            <option value="U1" ${defaults.process === 'U1' ? 'selected' : ''}>U1(æœƒè­°/è¨“ç·´)</option>
                            <option value="U2" ${defaults.process === 'U2' ? 'selected' : ''}>U2(è¨­å‚™åœæ©Ÿ)</option>
                            <option value="U3" ${defaults.process === 'U3' ? 'selected' : ''}>U3(åœå·¥å¾…æ–™)</option>
                            <option value="U4" ${defaults.process === 'U4' ? 'selected' : ''}>U4(å“è³ªç¢ºèª)</option>
                            <option value="U5" ${defaults.process === 'U5' ? 'selected' : ''}>U5(å·¥å‹™)</option>
                            <option value="U6" ${defaults.process === 'U6' ? 'selected' : ''}>U6(ç²¾å¯¦å°ˆæ¡ˆ)</option>
                            <option value="U7" ${defaults.process === 'U7' ? 'selected' : ''}>U7(é–‹æ²»å…·)</option>
                            <option value="U8" ${defaults.process === 'U8' ? 'selected' : ''}>U8(å¾…æ©Ÿ)</option>
                            <option value="U10" ${defaults.process === 'U10' ? 'selected' : ''}>U10(è«‹å‡)</option>
                        </select>
                    </div>
                    <div class="field-group">
                        <label class="field-label">è£½ä»¤è™Ÿç¢¼:</label>
                        <input type="text" class="field-input order-input" placeholder="å¿…é ˆ12ç¢¼" 
                               value="${defaults.orderNo}" 
                               maxlength="12"
                               pattern="[A-ZX0-9]{12}" 
                               onkeyup="this.value = this.value.toUpperCase().replace(/[^A-ZX0-9]/g, '')" 
                               onchange="validateOrderNumber(this)" />
                    </div>
                    <div class="field-group">
                        <label class="field-label">ä»¶è™Ÿ:</label>
                        <input type="text" class="field-input part-input" placeholder="è‹±æ–‡å¤§å¯«+æ•¸å­—+ç ´æŠ˜è™Ÿ" 
                               value="${defaults.partNo}"
                               pattern="[A-ZX0-9-]+" 
                               onkeyup="this.value = this.value.toUpperCase().replace(/[^A-ZX0-9-]/g, '')" />
                    </div>
                    <div class="field-group">
                        <label class="field-label">è£½ä»¤æ•¸é‡:</label>
                        <input type="number" class="field-input qty-input" placeholder="0" value="${defaults.orderQty}" min="0" />
                    </div>
                    <div class="field-group">
                        <label class="field-label">è‰¯å“:</label>
                        <input type="number" class="field-input good-input" placeholder="0" value="${defaults.good}" min="0" />
                    </div>
                    <div class="field-group">
                        <label class="field-label">ä¸è‰¯å“:</label>
                        <input type="number" class="field-input bad-input" placeholder="0" value="${defaults.bad}" min="0" />
                    </div>
                    <div class="field-group">
                        <label class="field-label">å‚™è¨»:</label>
                        <input type="text" class="field-input remark-input" placeholder="é¸å¡«" value="${defaults.remark}" />
                    </div>
                </div>
                <div class="card-actions">
                    <button class="btn btn-copy" onclick="copyCard(this)">è¤‡è£½</button>
                </div>
            `;
            
            // æ ¹æ“šè£½ç¨‹ä»£è™Ÿè¨­å®šåˆå§‹å€¼
            const processSelect = card.querySelector('.process-select');
            const processValue = processSelect.value;
            // åªæœ‰ç‰¹å®šé¸é …æœƒè‡ªå‹•å¡«å…¥ XXXXXXXXXXXX
            if (['51', 'G', 'U1', 'U2', 'U3', 'U4', 'U5', 'U6', 'U7', 'U8', 'U10'].includes(processValue)) {
                card.querySelector('.order-input').value = 'XXXXXXXXXXXX';
                card.querySelector('.part-input').value = 'XXXXXXXXXXXX';
                
                // å¦‚æœæ˜¯è«‹å‡ï¼Œæ©Ÿå°è‡ªå‹•é¸æ“‡X
                if (processValue === 'U10') {
                    card.querySelector('.machine-select').value = 'X';
                }
            }
            
            return card;
        }

        // è™•ç†è£½ç¨‹ä»£è™Ÿè®Šæ›´
        function handleProcessChange(selectElement) {
            const card = selectElement.closest('.entry-card');
            const orderInput = card.querySelector('.order-input');
            const partInput = card.querySelector('.part-input');
            const machineSelect = card.querySelector('.machine-select');
            
            // ç‰¹å®šé¸é …æœƒè‡ªå‹•å¡«å…¥
            if (['51', 'G', 'U1', 'U2', 'U3', 'U4', 'U5', 'U6', 'U7', 'U8', 'U10'].includes(selectElement.value)) {
                orderInput.value = 'XXXXXXXXXXXX';
                partInput.value = 'XXXXXXXXXXXX';
                
                // å¦‚æœæ˜¯è«‹å‡ï¼Œæ©Ÿå°è‡ªå‹•é¸æ“‡X
                if (selectElement.value === 'U10') {
                    machineSelect.value = 'X';
                }
            }
            // A, A1, AA1, B éƒ½ä¸è‡ªå‹•å¡«å…¥ï¼Œä¿æŒåŸå€¼
            
            validateTime();
        }

        // é©—è­‰è£½ä»¤è™Ÿç¢¼å¿…é ˆ12ä½
        function validateOrderNumber(input) {
            if (input.value.length !== 12) {
                input.classList.add('invalid');
                showMessage('è£½ä»¤è™Ÿç¢¼å¿…é ˆç‚º12ä½æ•¸', 'error');
            } else {
                input.classList.remove('invalid');
            }
        }

        // è¤‡è£½æ™‚æ®µå¡ç‰‡
        function copyCard(btn) {
            const originalCard = btn.closest('.entry-card');
            const endTime = originalCard.querySelector('.end-time').value;
            
            // æ”¶é›†åŸå¡ç‰‡çš„æ‰€æœ‰è³‡æ–™
            const cardData = {
                startTime: endTime, // é–‹å§‹æ™‚é–“æ¥çºŒä¸Šä¸€å€‹çµæŸæ™‚é–“
                endTime: '', // çµæŸæ™‚é–“ç•™ç©º
                machine: originalCard.querySelector('.machine-select').value,
                process: originalCard.querySelector('.process-select').value,
                orderNo: originalCard.querySelector('.order-input').value,
                partNo: originalCard.querySelector('.part-input').value,
                orderQty: originalCard.querySelector('.qty-input').value,
                good: originalCard.querySelector('.good-input').value,
                bad: originalCard.querySelector('.bad-input').value,
                remark: originalCard.querySelector('.remark-input').value
            };
            
            // å‰µå»ºæ–°å¡ç‰‡ä¸¦æ’å…¥åˆ°åŸå¡ç‰‡å¾Œé¢
            const newCard = createTimeCard(cardData);
            originalCard.parentNode.insertBefore(newCard, originalCard.nextSibling);
            
            // æ²å‹•åˆ°æ–°å¡ç‰‡
            newCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
            
            validateTime();
        }

        // æ–°å¢æ™‚æ®µè¡Œ
        function addNewRow() {
            const container = document.getElementById('entriesContainer');
            const newCard = createTimeCard();
            container.appendChild(newCard);
            
            // è‡ªå‹•æ²å‹•åˆ°æ–°å¢çš„å¡ç‰‡
            newCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        // åˆªé™¤æ™‚æ®µå¡ç‰‡
        function deleteCard(btn) {
            if (document.querySelectorAll('.entry-card').length > 1) {
                btn.closest('.entry-card').remove();
                validateTime();
            } else {
                showMessage('è‡³å°‘éœ€ä¿ç•™ä¸€å€‹æ™‚æ®µ', 'error');
            }
        }

        // å¡«å……æƒåœ°æ™‚é–“ - å„ªåŒ–ç‰ˆ
        function fillSweepingTime() {
            const container = document.getElementById('entriesContainer');
            const existingCards = Array.from(container.querySelectorAll('.entry-card'));
            
            // æª¢æŸ¥æ˜¯å¦å·²æœ‰æƒåœ°æ™‚é–“
            let hasSweepingTime = false;
            for (const card of existingCards) {
                const startTime = card.querySelector('.start-time').value;
                const endTime = card.querySelector('.end-time').value;
                const process = card.querySelector('.process-select').value;
                
                if (startTime === '08:00' && endTime === '08:15' && process === '51') {
                    hasSweepingTime = true;
                    showMessage('æƒåœ°æ™‚é–“å·²å­˜åœ¨', 'error');
                    return;
                }
            }
            
            // å¦‚æœæ²’æœ‰ä»»ä½•æ™‚æ®µï¼Œç›´æ¥æ–°å¢æƒåœ°æ™‚é–“
            if (existingCards.length === 0 || 
                (existingCards.length === 1 && !existingCards[0].querySelector('.start-time').value)) {
                // æ¸…ç©ºå®¹å™¨
                container.innerHTML = '';
                entryCount = 0;
                
                // æ–°å¢æƒåœ°æ™‚é–“
                const sweepCard = createTimeCard({
                    startTime: '08:00',
                    endTime: '08:15',
                    machine: 'X',
                    process: '51',
                    orderNo: 'XXXXXXXXXXXX',
                    partNo: 'XXXXXXXXXXXX',
                    orderQty: '0',
                    good: '0',
                    bad: '0',
                    remark: ''
                });
                container.appendChild(sweepCard);
                showMessage('å·²æ–°å¢æƒåœ°æ™‚é–“ (8:00-8:15)', 'success');
                validateTime();
                return;
            }
            
            // è™•ç†å·²æœ‰8:00é–‹å§‹çš„æ™‚æ®µ
            let processedCards = [];
            let sweepingInserted = false;
            
            for (const card of existingCards) {
                const startTime = card.querySelector('.start-time').value;
                const endTime = card.querySelector('.end-time').value;
                
                if (startTime === '08:00') {
                    if (!sweepingInserted) {
                        // æ’å…¥æƒåœ°æ™‚é–“
                        const sweepCard = createTimeCard({
                            startTime: '08:00',
                            endTime: '08:15',
                            machine: 'X',
                            process: '51',
                            orderNo: 'XXXXXXXXXXXX',
                            partNo: 'XXXXXXXXXXXX',
                            orderQty: '0',
                            good: '0',
                            bad: '0',
                            remark: ''
                        });
                        processedCards.push(sweepCard);
                        sweepingInserted = true;
                        
                        // è™•ç†åŸæœ‰çš„8:00æ™‚æ®µ
                        if (endTime > '08:15') {
                            // ä¿®æ”¹åŸæ™‚æ®µç‚º8:15é–‹å§‹
                            const modifiedCard = createTimeCard({
                                startTime: '08:15',
                                endTime: endTime,
                                machine: card.querySelector('.machine-select').value,
                                process: card.querySelector('.process-select').value,
                                orderNo: card.querySelector('.order-input').value,
                                partNo: card.querySelector('.part-input').value,
                                orderQty: card.querySelector('.qty-input').value,
                                good: card.querySelector('.good-input').value,
                                bad: card.querySelector('.bad-input').value,
                                remark: card.querySelector('.remark-input').value
                            });
                            processedCards.push(modifiedCard);
                        }
                        // å¦‚æœçµæŸæ™‚é–“<=08:15ï¼Œè©²æ™‚æ®µè¢«å®Œå…¨å–ä»£ï¼Œä¸å†åŠ å…¥
                    }
                } else {
                    // ä¿ç•™å…¶ä»–æ™‚æ®µ
                    const clonedCard = createTimeCard({
                        startTime: startTime,
                        endTime: endTime,
                        machine: card.querySelector('.machine-select').value,
                        process: card.querySelector('.process-select').value,
                        orderNo: card.querySelector('.order-input').value,
                        partNo: card.querySelector('.part-input').value,
                        orderQty: card.querySelector('.qty-input').value,
                        good: card.querySelector('.good-input').value,
                        bad: card.querySelector('.bad-input').value,
                        remark: card.querySelector('.remark-input').value
                    });
                    processedCards.push(clonedCard);
                }
            }
            
            // å¦‚æœæ²’æœ‰8:00çš„æ™‚æ®µï¼Œåœ¨æœ€å‰é¢æ’å…¥æƒåœ°æ™‚é–“
            if (!sweepingInserted) {
                const sweepCard = createTimeCard({
                    startTime: '08:00',
                    endTime: '08:15',
                    machine: 'X',
                    process: '51',
                    orderNo: 'XXXXXXXXXXXX',
                    partNo: 'XXXXXXXXXXXX',
                    orderQty: '0',
                    good: '0',
                    bad: '0',
                    remark: ''
                });
                processedCards.unshift(sweepCard);
            }
            
            // é‡æ–°å¡«å……å®¹å™¨
            container.innerHTML = '';
            entryCount = 0;
            processedCards.forEach(card => container.appendChild(card));
            
            showMessage('å·²æ–°å¢æƒåœ°æ™‚é–“ (8:00-8:15)', 'success');
            validateTime();
        }

        // æ¸…ç©ºæ‰€æœ‰
        function clearAll() {
            const container = document.getElementById('entriesContainer');
            container.innerHTML = '';
            entryCount = 0;
            addNewRow();
            showMessage('å·²æ¸…ç©ºæ‰€æœ‰æ™‚æ®µ', 'success');
        }

        // è·³è½‰åˆ°éŒ¯èª¤ä½ç½®
        function jumpToError(type) {
            const statusItem = document.getElementById(`${type}StatusItem`);
            
            // åªæœ‰åœ¨éŒ¯èª¤ç‹€æ…‹ä¸‹æ‰è·³è½‰
            if (!statusItem.classList.contains('error')) {
                return;
            }
            
            const cards = errorCards[type];
            if (cards && cards.length > 0) {
                const firstErrorCard = document.querySelector(`[data-card-id="${cards[0]}"]`);
                if (firstErrorCard) {
                    // ç§»é™¤æ‰€æœ‰highlight
                    document.querySelectorAll('.entry-card').forEach(card => {
                        card.classList.remove('highlight');
                    });
                    
                    // åŠ ä¸Šhighlight
                    firstErrorCard.classList.add('highlight');
                    
                    // è·³è½‰åˆ°è©²å¡ç‰‡
                    firstErrorCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    
                    // 3ç§’å¾Œç§»é™¤highlight
                    setTimeout(() => {
                        firstErrorCard.classList.remove('highlight');
                    }, 3000);
                }
            }
        }

        // è¨ˆç®—æ™‚é–“å·®ï¼ˆåˆ†é˜ï¼‰
        function calculateMinutes(startTime, endTime) {
            if (!startTime || !endTime) return 0;
            
            const start = new Date(`2000-01-01T${startTime}:00`);
            const end = new Date(`2000-01-01T${endTime}:00`);
            
            const diff = end - start;
            return Math.round(diff / 60000); // è½‰æ›ç‚ºåˆ†é˜
        }

        // é©—è­‰æ™‚é–“å’Œè³‡æ–™å®Œæ•´æ€§
        function validateTime() {
            const cards = document.querySelectorAll('.entry-card');
            let morningCovered = false;
            let afternoonCovered = false;
            let totalMinutes = 0;
            let dataComplete = true;
            let hasLunchTimeError = false;
            
            const timeSegments = [];
            
            // é‡ç½®éŒ¯èª¤è¨˜éŒ„
            errorCards = {
                morning: [],
                afternoon: [],
                data: []
            };
            
            cards.forEach(card => {
                const cardId = card.getAttribute('data-card-id');
                const startTime = card.querySelector('.start-time').value;
                const endTime = card.querySelector('.end-time').value;
                const machine = card.querySelector('.machine-select').value;
                const orderNo = card.querySelector('.order-input').value;
                
                // é‡ç½®éŒ¯èª¤ç‹€æ…‹
                card.classList.remove('error');
                card.querySelectorAll('.field-input').forEach(input => {
                    input.classList.remove('invalid');
                });
                
                // æª¢æŸ¥æ˜¯å¦æœ‰12:00-13:00çš„æ™‚æ®µ
                if (startTime && endTime) {
                    if ((startTime >= '12:00' && startTime < '13:00') || 
                        (endTime > '12:00' && endTime <= '13:00')) {
                        hasLunchTimeError = true;
                        card.classList.add('error');
                        errorCards.data.push(cardId);
                        showMessage('âš ï¸ è­¦å‘Šï¼š12:00-13:00ç‚ºä¼‘æ¯æ™‚é–“ï¼Œè«‹ç¢ºèªæ™‚é–“æ˜¯å¦å¡«å¯«æ­£ç¢º', 'error');
                    }
                    
                    // è¨ˆç®—ç¸½å·¥ä½œæ™‚æ•¸
                    totalMinutes += calculateMinutes(startTime, endTime);
                }
                
                if (startTime && endTime && !hasLunchTimeError) {
                    timeSegments.push({
                        start: startTime, 
                        end: endTime,
                        cardId: cardId
                    });
                    
                    // æª¢æŸ¥ä¸Šåˆæ™‚æ®µè¦†è“‹ (8:00-12:00)
                    if (startTime <= '08:00' && endTime >= '12:00') {
                        morningCovered = true;
                    } else if (startTime < '12:00' && endTime > '08:00') {
                        morningCovered = checkFullCoverage(timeSegments, '08:00', '12:00');
                    }
                    
                    // æª¢æŸ¥ä¸‹åˆæ™‚æ®µè¦†è“‹ (13:00-17:00)
                    if (startTime <= '13:00' && endTime >= '17:00') {
                        afternoonCovered = true;
                    } else if (startTime < '17:00' && endTime > '13:00') {
                        afternoonCovered = checkFullCoverage(timeSegments, '13:00', '17:00');
                    }
                }
                
                // æª¢æŸ¥å¿…å¡«æ¬„ä½ï¼ˆæ©Ÿå°å’Œè£½ä»¤è™Ÿç¢¼ï¼‰
                if (startTime && endTime && (!machine || !orderNo)) {
                    dataComplete = false;
                    errorCards.data.push(cardId);
                    if (!machine) card.querySelector('.machine-select').classList.add('invalid');
                    if (!orderNo) card.querySelector('.order-input').classList.add('invalid');
                }
                
                // æª¢æŸ¥è£½ä»¤è™Ÿç¢¼æ˜¯å¦ç‚º12ä½
                if (orderNo && orderNo.length !== 12) {
                    dataComplete = false;
                    errorCards.data.push(cardId);
                    card.querySelector('.order-input').classList.add('invalid');
                }
            });
            
            // æ‰¾å‡ºæœªè¦†è“‹çš„æ™‚æ®µ
            if (!morningCovered) {
                errorCards.morning = findUncoveredCards(timeSegments, '08:00', '12:00');
            }
            if (!afternoonCovered) {
                errorCards.afternoon = findUncoveredCards(timeSegments, '13:00', '17:00');
            }
            
            // è¨ˆç®—å·¥æ™‚ç‹€æ…‹
            const workHours = Math.floor(totalMinutes / 60);
            const workMinutes = totalMinutes % 60;
            const isWorkHoursComplete = totalMinutes >= 480; // 8å°æ™‚ = 480åˆ†é˜
            
            // æ›´æ–°é©—è­‰ç‹€æ…‹é¡¯ç¤º
            updateStatus('morningStatus', 'morningText', 'morningStatusItem', 
                        morningCovered && !hasLunchTimeError, 'ä¸Šåˆæ™‚æ®µå·²å®Œæ•´è¦†è“‹', 'ä¸Šåˆæ™‚æ®µæœªå®Œæ•´è¦†è“‹');
            updateStatus('afternoonStatus', 'afternoonText', 'afternoonStatusItem',
                        afternoonCovered && !hasLunchTimeError, 'ä¸‹åˆæ™‚æ®µå·²å®Œæ•´è¦†è“‹', 'ä¸‹åˆæ™‚æ®µæœªå®Œæ•´è¦†è“‹');
            updateStatus('workHoursStatus', 'workHoursText', 'workHoursStatusItem',
                        isWorkHoursComplete, `å·¥æ™‚å·²æ»¿8å°æ™‚ï¼ˆ${workHours}å°æ™‚${workMinutes}åˆ†ï¼‰`, 
                        `å·¥æ™‚ä¸è¶³8å°æ™‚ï¼ˆç›®å‰${workHours}å°æ™‚${workMinutes}åˆ†ï¼‰`);
            updateStatus('dataStatus', 'dataText', 'dataStatusItem',
                        dataComplete && !hasLunchTimeError, 'è³‡æ–™å¡«å¯«å®Œæ•´', 
                        hasLunchTimeError ? '12:00-13:00ç‚ºä¼‘æ¯æ™‚é–“' : 'æ©Ÿå°æˆ–è£½ä»¤è™Ÿæœªå¡«å¯«');
            
            return morningCovered && afternoonCovered && isWorkHoursComplete && dataComplete && !hasLunchTimeError;
        }

        function checkFullCoverage(segments, requiredStart, requiredEnd) {
            segments.sort((a, b) => a.start.localeCompare(b.start));
            
            let currentTime = requiredStart;
            for (const segment of segments) {
                if (segment.start <= currentTime && segment.end > currentTime) {
                    currentTime = segment.end;
                    if (currentTime >= requiredEnd) {
                        return true;
                    }
                }
            }
            return false;
        }

        function findUncoveredCards(segments, requiredStart, requiredEnd) {
            const uncoveredCards = [];
            segments.forEach(segment => {
                // å¦‚æœæ™‚æ®µåœ¨è¦æ±‚ç¯„åœå…§ä½†æ²’æœ‰å®Œå…¨è¦†è“‹
                if ((segment.start >= requiredStart && segment.start < requiredEnd) ||
                    (segment.end > requiredStart && segment.end <= requiredEnd)) {
                    uncoveredCards.push(segment.cardId);
                }
            });
            
            // å¦‚æœæ²’æœ‰ä»»ä½•æ™‚æ®µåœ¨ç¯„åœå…§ï¼Œè¿”å›ç¬¬ä¸€å€‹å¡ç‰‡
            if (uncoveredCards.length === 0 && segments.length > 0) {
                uncoveredCards.push(segments[0].cardId);
            }
            
            return uncoveredCards;
        }

        function updateStatus(iconId, textId, itemId, isValid, successText, errorText) {
            const icon = document.getElementById(iconId);
            const text = document.getElementById(textId);
            const item = document.getElementById(itemId);
            
            if (isValid) {
                icon.className = 'status-icon success';
                icon.textContent = 'âœ“';
                text.textContent = successText;
                item.classList.remove('error');
            } else {
                icon.className = 'status-icon error';
                icon.textContent = 'âœ—';
                text.textContent = errorText;
                item.classList.add('error');
            }
        }

        // é©—è­‰ä¸¦å„²å­˜
        function validateAndSave() {
            // æª¢æŸ¥å“¡å·¥è³‡è¨Š
            const employeeId = document.getElementById('employeeId').value;
            const employeeName = document.getElementById('employeeName').value;
            
            if (!employeeId || !employeeName) {
                showMessage('è«‹å¡«å¯«å“¡å·¥ç·¨è™Ÿå’Œå§“å', 'error');
                
                // è·³åˆ°æœªå¡«å¯«çš„æ¬„ä½
                if (!employeeId) {
                    document.getElementById('employeeId').scrollIntoView({ behavior: 'smooth', block: 'center' });
                    document.getElementById('employeeId').focus();
                    document.getElementById('employeeId').classList.add('shake');
                    setTimeout(() => {
                        document.getElementById('employeeId').classList.remove('shake');
                    }, 500);
                } else if (!employeeName) {
                    document.getElementById('employeeName').scrollIntoView({ behavior: 'smooth', block: 'center' });
                    document.getElementById('employeeName').focus();
                    document.getElementById('employeeName').classList.add('shake');
                    setTimeout(() => {
                        document.getElementById('employeeName').classList.remove('shake');
                    }, 500);
                }
                return;
            }
            
            // é©—è­‰æ™‚é–“å’Œè³‡æ–™
            if (!validateTime()) {
                // æ‰¾åˆ°ç¬¬ä¸€å€‹æœ‰éŒ¯èª¤çš„æ¬„ä½ä¸¦è·³è½‰
                const firstInvalid = document.querySelector('.invalid');
                if (firstInvalid) {
                    firstInvalid.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    firstInvalid.focus();
                    firstInvalid.classList.add('shake');
                    setTimeout(() => {
                        firstInvalid.classList.remove('shake');
                    }, 500);
                }
                
                showMessage('âŒ é©—è­‰å¤±æ•—ï¼è«‹æª¢æŸ¥æ¨™è¨˜ç´…è‰²çš„æ¬„ä½', 'error');
                return;
            }
            
            // å„²å­˜å“¡å·¥è³‡æ–™åˆ°æœ¬åœ°å„²å­˜
            saveEmployeeData();
            
            // æ¨¡æ“¬å„²å­˜åˆ°å¾Œç«¯
            showMessage('âœ… é©—è­‰é€šéï¼æ—¥å ±è¡¨å·²æˆåŠŸå„²å­˜', 'success');
            
            // æ¨¡æ“¬å„²å­˜å‹•ç•«
            document.querySelector('.btn-primary').classList.add('pulse');
            setTimeout(() => {
                document.querySelector('.btn-primary').classList.remove('pulse');
            }, 2000);
        }

        // å–å¾—æ˜ŸæœŸå¹¾çš„ä¸­æ–‡
        function getChineseDayOfWeek(date) {
            const days = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
            return days[date.getDay()];
        }

        // è½‰æ›æ™‚é–“æ ¼å¼ (08:00 -> 0800)
        function formatTimeForExcel(timeStr) {
            if (!timeStr) return '';
            return timeStr.replace(':', '');
        }

        // è¥¿å…ƒå¹´è½‰æ°‘åœ‹å¹´
        function toROCYear(date) {
            return date.getFullYear() - 1911;
        }

        // æ”¶é›†å ±è¡¨æ•¸æ“š
        function collectReportData() {
            const reportDate = new Date(document.getElementById('reportDate').value);
            const employeeName = document.getElementById('employeeName').value;
            const cards = document.querySelectorAll('.entry-card');
            
            const data = [];
            
            cards.forEach(card => {
                const startTime = card.querySelector('.start-time').value;
                const endTime = card.querySelector('.end-time').value;
                const machine = card.querySelector('.machine-select').value;
                const processCode = card.querySelector('.process-select').value;
                const orderNo = card.querySelector('.order-input').value;
                const partNo = card.querySelector('.part-input').value;
                const orderQty = card.querySelector('.qty-input').value || '0';
                const good = card.querySelector('.good-input').value || '0';
                const bad = card.querySelector('.bad-input').value || '0';
                const remark = card.querySelector('.remark-input').value || '';
                
                if (startTime && endTime) {
                    data.push({
                        year: toROCYear(reportDate),
                        month: reportDate.getMonth() + 1,
                        day: reportDate.getDate(),
                        weekday: getChineseDayOfWeek(reportDate),
                        unit: 'åŠ å·¥éƒ¨',
                        employee: employeeName,
                        startTime: formatTimeForExcel(startTime),
                        machine: machine,
                        processCode: processCode,
                        orderNo: orderNo,
                        partNo: partNo,
                        orderQty: orderQty,
                        good: good,
                        bad: bad,
                        endTime: formatTimeForExcel(endTime),
                        remark: remark,
                        minutes: calculateMinutes(startTime, endTime)
                    });
                }
            });
            
            return data;
        }

        // åˆå§‹åŒ–è§¸æ§ç¸®æ”¾
        function initTouchZoom() {
            const modalBody = document.querySelector('.modal-body');
            const previewContent = document.querySelector('.preview-content');
            
            let lastDistance = 0;
            let initialDistance = 0;
            
            modalBody.addEventListener('touchstart', function(e) {
                if (e.touches.length === 2) {
                    initialDistance = getDistance(e.touches[0], e.touches[1]);
                    lastDistance = initialDistance;
                }
            });
            
            modalBody.addEventListener('touchmove', function(e) {
                if (e.touches.length === 2) {
                    const currentDistance = getDistance(e.touches[0], e.touches[1]);
                    const scale = currentDistance / initialDistance;
                    
                    currentScale = Math.min(Math.max(0.5, scale), 3);
                    previewContent.style.transform = `scale(${currentScale})`;
                    
                    lastDistance = currentDistance;
                }
            });
            
            function getDistance(touch1, touch2) {
                const dx = touch1.clientX - touch2.clientX;
                const dy = touch1.clientY - touch2.clientY;
                return Math.sqrt(dx * dx + dy * dy);
            }
        }

        // æ›´æ–°è¡¨æ ¼è³‡æ–™
        function updateTableData(row, field, value) {
            const cardIndex = parseInt(row.getAttribute('data-row-index'));
            const cards = document.querySelectorAll('.entry-card');
            
            if (cards[cardIndex]) {
                const card = cards[cardIndex];
                
                // æ ¹æ“šæ¬„ä½æ›´æ–°å°æ‡‰çš„è¼¸å…¥æ¡†
                switch(field) {
                    case 'startTime':
                        card.querySelector('.start-time').value = value.length === 4 ? 
                            value.substring(0,2) + ':' + value.substring(2,4) : value;
                        break;
                    case 'endTime':
                        card.querySelector('.end-time').value = value.length === 4 ? 
                            value.substring(0,2) + ':' + value.substring(2,4) : value;
                        break;
                    case 'machine':
                        card.querySelector('.machine-select').value = value;
                        break;
                    case 'processCode':
                        card.querySelector('.process-select').value = value;
                        break;
                    case 'orderNo':
                        card.querySelector('.order-input').value = value;
                        break;
                    case 'partNo':
                        card.querySelector('.part-input').value = value;
                        break;
                    case 'orderQty':
                        card.querySelector('.qty-input').value = value;
                        break;
                    case 'good':
                        card.querySelector('.good-input').value = value;
                        break;
                    case 'bad':
                        card.querySelector('.bad-input').value = value;
                        break;
                    case 'remark':
                        card.querySelector('.remark-input').value = value;
                        break;
                }
            }
        }

        // é è¦½å ±è¡¨
        function previewReport() {
            if (!validateTime()) {
                showMessage('è«‹å…ˆä¿®æ­£é©—è­‰éŒ¯èª¤', 'error');
                return;
            }
            
            const employeeName = document.getElementById('employeeName').value || 'æœªå¡«å¯«';
            const employeeId = document.getElementById('employeeId').value || 'æœªå¡«å¯«';
            const reportDate = document.getElementById('reportDate').value;
            const data = collectReportData();
            
            // è¨ˆç®—çµ±è¨ˆè³‡æ–™
            let totalGood = 0;
            let totalBad = 0;
            let totalMinutes = 0;
            
            data.forEach(row => {
                totalGood += parseInt(row.good) || 0;
                totalBad += parseInt(row.bad) || 0;
                totalMinutes += parseInt(row.minutes) || 0;
            });
            
            const totalRate = totalGood > 0 ? ((totalGood / (totalGood + totalBad)) * 100).toFixed(1) : 0;
            const totalHours = Math.floor(totalMinutes / 60);
            const remainMinutes = totalMinutes % 60;
            
            // å»ºç«‹é è¦½HTMLï¼ˆå¯ç·¨è¼¯ç‰ˆï¼‰
            let previewHTML = `
                <div class="summary-info">
                    <div class="summary-item">
                        <span class="summary-label">å“¡å·¥ç·¨è™Ÿï¼š</span>
                        <span class="summary-value">${employeeId}</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">å“¡å·¥å§“åï¼š</span>
                        <span class="summary-value">${employeeName}</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">å ±è¡¨æ—¥æœŸï¼š</span>
                        <span class="summary-value">${reportDate}</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">éƒ¨é–€ï¼š</span>
                        <span class="summary-value">åŠ å·¥éƒ¨</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">ç¸½è‰¯å“æ•¸ï¼š</span>
                        <span class="summary-value">${totalGood}</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">ç¸½ä¸è‰¯å“æ•¸ï¼š</span>
                        <span class="summary-value">${totalBad}</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">è‰¯ç‡ï¼š</span>
                        <span class="summary-value">${totalRate}%</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">ç¸½å·¥æ™‚ï¼š</span>
                        <span class="summary-value">${totalHours}å°æ™‚${remainMinutes}åˆ†é˜</span>
                    </div>
                </div>
                
                <h3>ğŸ“‹ è©³ç´°æ™‚æ®µè¨˜éŒ„ï¼ˆå¯ç›´æ¥ç·¨è¼¯ï¼‰</h3>
                <div style="overflow-x: auto;">
                    <table class="preview-table">
                        <thead>
                            <tr>
                                <th>å·¥ä½œèµ·</th>
                                <th>å·¥ä½œè¿„</th>
                                <th>åˆ†é˜</th>
                                <th>è¨­å‚™ç·¨è™Ÿ</th>
                                <th>è£½ç¨‹ä»£è™Ÿ</th>
                                <th>è£½ä»¤å–®è™Ÿ</th>
                                <th>å“è™Ÿ</th>
                                <th>è£½ä»¤æ•¸</th>
                                <th>è‰¯å“</th>
                                <th>ä¸è‰¯å“</th>
                                <th>å‚™è¨»</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            data.forEach((row, index) => {
                previewHTML += `
                    <tr data-row-index="${index}">
                        <td><input type="text" value="${row.startTime}" onchange="updateTableData(this.closest('tr'), 'startTime', this.value)"></td>
                        <td><input type="text" value="${row.endTime}" onchange="updateTableData(this.closest('tr'), 'endTime', this.value)"></td>
                        <td>${row.minutes}</td>
                        <td><input type="text" value="${row.machine}" onchange="updateTableData(this.closest('tr'), 'machine', this.value)"></td>
                        <td><input type="text" value="${row.processCode}" onchange="updateTableData(this.closest('tr'), 'processCode', this.value)"></td>
                        <td><input type="text" value="${row.orderNo}" onchange="updateTableData(this.closest('tr'), 'orderNo', this.value)"></td>
                        <td><input type="text" value="${row.partNo}" onchange="updateTableData(this.closest('tr'), 'partNo', this.value)"></td>
                        <td><input type="text" value="${row.orderQty}" onchange="updateTableData(this.closest('tr'), 'orderQty', this.value)"></td>
                        <td><input type="text" value="${row.good}" onchange="updateTableData(this.closest('tr'), 'good', this.value)"></td>
                        <td><input type="text" value="${row.bad}" onchange="updateTableData(this.closest('tr'), 'bad', this.value)"></td>
                        <td><input type="text" value="${row.remark}" onchange="updateTableData(this.closest('tr'), 'remark', this.value)"></td>
                    </tr>
                `;
            });
            
            previewHTML += `
                        </tbody>
                    </table>
                </div>
            `;
            
            // é¡¯ç¤ºModal
            document.getElementById('modalBody').innerHTML = previewHTML;
            document.getElementById('previewModal').style.display = 'block';
            currentScale = 1;
            document.querySelector('.preview-content').style.transform = 'scale(1)';
        }

        // é—œé–‰é è¦½Modal
        function closePreviewModal() {
            document.getElementById('previewModal').style.display = 'none';
            // é—œé–‰æ™‚é‡æ–°é©—è­‰
            validateTime();
        }

        // é»æ“ŠModalå¤–éƒ¨é—œé–‰
        window.onclick = function(event) {
            const modal = document.getElementById('previewModal');
            if (event.target == modal) {
                modal.style.display = 'none';
                validateTime();
            }
        }

        // åŒ¯å‡ºExcel
        function exportToExcel() {
            if (!validateTime()) {
                showMessage('è«‹å…ˆä¿®æ­£é©—è­‰éŒ¯èª¤', 'error');
                
                const firstInvalid = document.querySelector('.invalid');
                if (firstInvalid) {
                    firstInvalid.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    firstInvalid.focus();
                }
                return;
            }
            
            const employeeName = document.getElementById('employeeName').value;
            if (!employeeName) {
                showMessage('è«‹å¡«å¯«å“¡å·¥å§“å', 'error');
                return;
            }
            
            showMessage('æ­£åœ¨ç”ŸæˆExcelå ±è¡¨...', 'success');
            
            const data = collectReportData();
            
            // æº–å‚™Excelè³‡æ–™ï¼ˆåˆªé™¤è£½ç¨‹ã€å“åè¦æ ¼ã€åˆ†é˜æ¬„ä½ï¼‰
            const wsData = [
                ['å¹´', 'æœˆ', 'æ—¥', 'æ˜ŸæœŸ', 'å–®ä½', 'äººå“¡', 'å·¥ä½œèµ·', 'è¨­å‚™ç·¨è™Ÿ', 'è£½ç¨‹ä»£è™Ÿ', 
                 'è£½ä»¤å–®è™Ÿ', 'å“è™Ÿ', 'è£½ä»¤æ•¸', 'è‰¯å“', 'ä¸è‰¯å“', 'å·¥ä½œè¿„', 'å‚™è¨»']
            ];
            
            data.forEach(row => {
                wsData.push([
                    row.year,
                    row.month,
                    row.day,
                    row.weekday,
                    row.unit,
                    row.employee,
                    row.startTime,
                    row.machine,
                    row.processCode,
                    row.orderNo,
                    row.partNo,
                    row.orderQty,
                    row.good,
                    row.bad,
                    row.endTime,
                    row.remark
                ]);
            });
            
            // å»ºç«‹å·¥ä½œè¡¨
            const ws = XLSX.utils.aoa_to_sheet(wsData);
            
            // è¨­å®šæ¬„å¯¬
            ws['!cols'] = [
                { wch: 5 },  // å¹´
                { wch: 5 },  // æœˆ
                { wch: 5 },  // æ—¥
                { wch: 6 },  // æ˜ŸæœŸ
                { wch: 8 },  // å–®ä½
                { wch: 10 }, // äººå“¡
                { wch: 8 },  // å·¥ä½œèµ·
                { wch: 12 }, // è¨­å‚™ç·¨è™Ÿ
                { wch: 10 }, // è£½ç¨‹ä»£è™Ÿ
                { wch: 15 }, // è£½ä»¤å–®è™Ÿ
                { wch: 20 }, // å“è™Ÿ
                { wch: 8 },  // è£½ä»¤æ•¸
                { wch: 6 },  // è‰¯å“
                { wch: 8 },  // ä¸è‰¯å“
                { wch: 8 },  // å·¥ä½œè¿„
                { wch: 20 }  // å‚™è¨»
            ];
            
            // è¨­å®šå„²å­˜æ ¼é¡è‰²
            const range = XLSX.utils.decode_range(ws['!ref']);
            for (let R = 0; R <= range.e.r; ++R) {
                for (let C = 0; C <= range.e.c; ++C) {
                    const cell_address = {c: C, r: R};
                    const cell_ref = XLSX.utils.encode_cell(cell_address);
                    
                    if (!ws[cell_ref]) continue;
                    
                    // åˆå§‹åŒ–å„²å­˜æ ¼æ¨£å¼
                    if (!ws[cell_ref].s) ws[cell_ref].s = {};
                    
                    // è¨­å®šå¡«å……é¡è‰²
                    if (C >= 0 && C <= 8) {
                        // A-Iæ¬„ï¼šè—è‰²
                        ws[cell_ref].s.fill = {
                            patternType: "solid",
                            fgColor: { rgb: "B8CCE4" }
                        };
                    } else if (C >= 9 && C <= 10) {
                        // J-Kæ¬„ï¼šç¶ è‰²
                        ws[cell_ref].s.fill = {
                            patternType: "solid",
                            fgColor: { rgb: "C4D79B" }
                        };
                    } else if (C >= 11 && C <= 13) {
                        // L-Næ¬„ï¼šé»ƒè‰²
                        ws[cell_ref].s.fill = {
                            patternType: "solid",
                            fgColor: { rgb: "FFFF99" }
                        };
                    } else if (C === 14) {
                        // Oæ¬„ï¼šç°è‰²
                        ws[cell_ref].s.fill = {
                            patternType: "solid",
                            fgColor: { rgb: "D9D9D9" }
                        };
                    }
                    // Pæ¬„ï¼ˆå‚™è¨»ï¼‰ä¸å¡«è‰²
                }
            }
            
            // å»ºç«‹æ´»é ç°¿
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'æ—¥å ±è¡¨');
            
            // ç”Ÿæˆæª”å
            const reportDate = document.getElementById('reportDate').value.replace(/-/g, '');
            const fileName = `${employeeName}_${reportDate}.xlsx`;
            
            // ä¸‹è¼‰æª”æ¡ˆ
            XLSX.writeFile(wb, fileName);
            
            setTimeout(() => {
                showMessage(`Excelå ±è¡¨å·²ç”Ÿæˆä¸¦ä¸‹è¼‰ï¼æª”åï¼š${fileName}`, 'success');
            }, 500);
        }

        // é¡¯ç¤ºè¨Šæ¯
        function showMessage(text, type) {
            const messageBox = document.getElementById('messageBox');
            messageBox.textContent = text;
            messageBox.className = `message ${type}`;
            
            setTimeout(() => {
                messageBox.className = 'message';
            }, 3000);
        }

        // åˆå§‹åŒ–
        window.onload = function() {
            initDateTime();
            loadEmployeeData();
            addNewRow();
        }
    </script>
</body>
</html>
